<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cr√¥nicas do Infinito - Edi√ß√£o Port√°til</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=MedievalSharp&family=Inter:wght@300;400;600&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: transparent;
            /* Alterado para permitir que o fundo fixo apare√ßa */
            color: #e4e4e7;
            overflow: hidden;
        }

        .font-fantasy {
            font-family: 'Cinzel', serif;
        }

        .font-medieval {
            font-family: 'MedievalSharp', cursive;
        }

        .glass-card {
            background: rgba(20, 20, 25, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .ornate-border {
            position: relative;
        }

        .ornate-border::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(245, 158, 11, 0.5), transparent);
        }

        .ornate-border::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(245, 158, 11, 0.5), transparent);
        }

        .scroll-hide::-webkit-scrollbar {
            display: none;
        }

        .scroll-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide {
            animation: slideIn 0.4s ease-out forwards;
        }

        .action-btn {
            transition: all 0.2s;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .action-btn:active {
            transform: translateY(0);
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script src="./assets/js/game-lib.js"></script>
    <script type="text/babel">
        /* 
           ================================================================
           SE√á√ÉO 1: BANCO DE DADOS DO JOGO
           Aqui voc√™ pode editar Ra√ßas, Classes, Magias, Itens e Locais.
           ================================================================
        */

        /* 
           ================================================================
           SE√á√ÉO 1: BANCO DE DADOS DO JOGO
           MOVIDO PARA: assets/js/game-lib.js
           ================================================================
        */

        // --- Componente: Card de Feature ---
        const FeatureCard = ({ title, desc, icon }) => (
            <div className="bg-zinc-900/50 backdrop-blur-sm border border-zinc-800 p-6 rounded-xl hover:border-amber-500/50 transition-colors group">
                <div className="text-4xl mb-4 group-hover:scale-110 transition-transform">{icon}</div>
                <h3 className="text-xl font-bold text-amber-500 mb-2 font-medieval">{title}</h3>
                <p className="text-zinc-400 text-sm leading-relaxed">{desc}</p>
            </div>
        );

        // --- Componente: Landing Page (P√°gina Inicial) ---
        const LandingPage = ({ onNovo, onCarregar, onImportar }) => (
            <div className="min-h-screen relative overflow-hidden font-sans flex flex-col">
                {/* Background Imersivo Animado - RPG Theme */}
                <div className="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1514539079130-25950c84af65?q=80&w=2000')] bg-cover bg-center animate-pulse-slow scale-105"></div>
                <div className="absolute inset-0 bg-gradient-to-b from-black/80 via-black/40 to-black"></div>

                {/* Navbar Simples */}
                <nav className="relative z-20 flex justify-between items-center p-6 w-full max-w-7xl mx-auto">
                    <div className="text-xl font-bold font-medieval text-amber-500 tracking-widest">CR√îNICAS RPG</div>
                    <div className="text-xs text-zinc-500 uppercase tracking-widest">Vers√£o 1.2</div>
                </nav>

                {/* Hero Section */}
                <div className="relative z-10 flex-1 flex flex-col items-center justify-center text-center p-4 -mt-10 md:-mt-20">
                    <div className="animate-slide-in">
                        <h1 className="text-6xl md:text-9xl font-medieval text-transparent bg-clip-text bg-gradient-to-b from-amber-300 to-amber-700 drop-shadow-[0_10px_20px_rgba(0,0,0,0.8)] mb-2">
                            CR√îNICAS
                            <span className="block text-4xl md:text-6xl text-zinc-400 mt-2">DO INFINITO</span>
                        </h1>
                        <p className="text-lg md:text-2xl text-zinc-300 font-fantasy tracking-wider mb-8 max-w-3xl mx-auto leading-relaxed shadow-black drop-shadow-md">
                            A aventura definitiva no seu navegador. <br />
                            <span className="text-amber-500">Sem installs. Sem downloads. Apenas gl√≥ria.</span>
                        </p>

                        <div className="flex flex-col md:flex-row gap-4 justify-center items-center w-full max-w-lg mx-auto mb-10">
                            <button onClick={onNovo} className="w-full md:w-auto px-10 py-5 bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-500 hover:to-amber-600 text-white font-bold text-xl rounded-xl shadow-[0_0_30px_rgba(245,158,11,0.3)] transition-all hover:scale-105 border border-amber-400 relative overflow-hidden group">
                                <span className="relative z-10 flex items-center justify-center gap-2">‚öîÔ∏è JOGAR AGORA <span className="text-xs opacity-70 block font-normal">(Criar Conta)</span></span>
                            </button>

                            <div className="flex gap-2 w-full md:w-auto">
                                <button onClick={onCarregar} className="flex-1 px-6 py-5 bg-zinc-900/80 hover:bg-zinc-800 text-zinc-300 font-bold text-lg rounded-xl border border-zinc-700 hover:border-zinc-500 transition-all backdrop-blur-sm">
                                    CONTINUAR
                                </button>
                                <button onClick={onImportar} className="px-6 py-5 bg-zinc-900/80 hover:bg-zinc-800 text-zinc-300 font-bold text-lg rounded-xl border border-zinc-700 hover:border-zinc-500 transition-all backdrop-blur-sm" title="Carregar Arquivo de Save">
                                    üìÇ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                {/* News & Features - Subida (padding reduzido) */}
                <div className="relative z-10 bg-black/80 border-t border-zinc-800 w-full py-10 md:py-12">
                    <div className="max-w-7xl mx-auto px-6">
                        <h2 className="text-2xl font-medieval text-center text-zinc-400 mb-8 uppercase tracking-widest"><span className="text-amber-600 mx-2">‚ô¶</span> Destaques da Atualiza√ß√£o <span className="text-amber-600 mx-2">‚ô¶</span></h2>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <FeatureCard
                                icon="üêâ"
                                title="Chefes Lend√°rios"
                                desc="Enfrente o Drag√£o Branco nas Montanhas de Gelo e prove seu valor para obter armas divinas."
                            />
                            <FeatureCard
                                icon="üíæ"
                                title="Save Port√°til"
                                desc="Seu progresso √© seu! Baixe seu save (arquivo) e leve para qualquer computador ou celular."
                            />
                            <FeatureCard
                                icon="üèÜ"
                                title="Arena de Combate"
                                desc="Participe do Grande Campeonato e ganhe pr√™mios exclusivos testando sua build."
                            />
                        </div>
                    </div>
                </div>

                {/* Footer */}
                <footer className="relative z-10 bg-black py-8 text-center text-zinc-600 text-sm">
                    <p>&copy; 2026 StudioRPG. Todos os direitos reservados.</p>
                </footer>
            </div>
        );

        // --- Imagens de Bioma ---
        // MOVIDO PARA game-lib.js

        const MenuPrincipal = ({ onNovo, onContinuar, onCarregar, temSave }) => (
            <div className="min-h-screen flex flex-col items-center justify-center bg-black p-4 bg-[url('https://images.unsplash.com/photo-1605806616949-1e87b487bc2a?q=80&w=2560')] bg-cover relative">
                <div className="absolute inset-0 bg-black/60 backdrop-blur-[2px]"></div>
                <div className="relative z-10 text-center animate-slide">
                    <h1 className="text-6xl md:text-8xl font-medieval text-amber-500 mb-2 drop-shadow-[0_0_15px_rgba(245,158,11,0.8)]">Menu Pause</h1>

                    <div className="flex flex-col gap-4 w-full max-w-md mx-auto mt-12">
                        <button onClick={onContinuar} className="action-btn px-8 py-4 bg-amber-600 hover:bg-amber-500 text-black font-bold rounded-xl text-xl border-2 border-amber-400 shadow-[0_0_20px_rgba(245,158,11,0.3)]">
                            VOLTAR AO JOGO
                        </button>
                        <button onClick={onNovo} className="action-btn px-8 py-4 bg-zinc-800 hover:bg-zinc-700 text-zinc-100 font-bold rounded-xl text-xl border border-zinc-600">
                            MENU INICIAL
                        </button>
                    </div>
                </div>
            </div>
        );

        const App = () => {
            const [view, setView] = React.useState('landing'); // Come√ßa na Landing Page

            const [jogador, setJogador] = React.useState(null);
            const [logs, setLogs] = React.useState([]);
            const [monstros, setMonstros] = React.useState([]);
            const [modal, setModal] = React.useState(null);
            const [missoesDisponiveis, setMissoesDisponiveis] = React.useState([]);
            const [versaoSave, setVersaoSave] = React.useState(0);
            const [saveId, setSaveId] = React.useState(null); // ID do save atual carregado

            // --- ESTADO CAMPEONATO ---
            const [campeonatoDisponivel, setCampeonatoDisponivel] = React.useState(false);
            const [tempoAteCampeonato, setTempoAteCampeonato] = React.useState(600); // 10 minutos (600s)
            const [rodadaCampeonato, setRodadaCampeonato] = React.useState(0);
            const [campeonatoAtivo, setCampeonatoAtivo] = React.useState(false);

            const logRef = React.useRef(null);



            // --- TIMER DO CAMPEONATO ---
            React.useEffect(() => {
                const timer = setInterval(() => {
                    setTempoAteCampeonato(prev => {
                        if (prev <= 0) {
                            setCampeonatoDisponivel(true);
                            // Se ficar dispon√≠vel, reinicia o contador para fechar ou pr√≥ximo ciclo
                            // Vamos deixar dispon√≠vel por 2 minutos
                            if (prev <= -120) { // 2 minutos aberto
                                setCampeonatoDisponivel(false);
                                return 600; // Reseta para 10 min
                            }
                            return prev - 1;
                        }
                        return prev - 1;
                    });
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            React.useEffect(() => {
                if (logRef.current) logRef.current.scrollTop = logRef.current.scrollHeight;
            }, [logs]);

            const addLog = (msg, tipo = 'comum') => {
                setLogs(prevLogs => [...prevLogs, { id: Date.now(), msg, tipo }]);
            };

            const evoluirAtributo = (attr) => {
                if (!jogador.pontosAtributo || jogador.pontosAtributo <= 0) return addLog("Sem pontos de atributo!");

                setJogador(p => ({
                    ...p,
                    pontosAtributo: p.pontosAtributo - 1,
                    atributosBase: {
                        ...p.atributosBase,
                        [attr]: p.atributosBase[attr] + 1
                    }
                }));
                addLog(`Aumentou ${attr} para ${jogador.atributosBase[attr] + 1}!`, 'upgrade');
            };

            const criarPersonagem = (dados) => {
                const racaData = RACAS[dados.raca];
                const stats = { forca: 1, habilidade: 1, resistencia: 1, armadura: 1, poderDeFogo: 1 };
                Object.keys(racaData.bonus).forEach(k => stats[k] += racaData.bonus[k]);

                // Aplica B√¥nus de Classe
                const classeData = CLASSES[dados.classe];
                if (classeData.bonus) {
                    Object.keys(classeData.bonus).forEach(k => stats[k] += classeData.bonus[k]);
                }

                // Aplica Tra√ßos Raciais Iniciais (HP/Mana/Defesa)
                let hpExtra = 0;
                let manaExtra = 0;

                // An√£o: Pele de Pedra (+20 HP)
                if (dados.raca === 'An√£o') hpExtra += 20;

                // Elfo: Gra√ßa √âlfica (+10 Mana Inicial)
                if (dados.raca === 'Elfo') manaExtra += 10;

                // Celestial: Prote√ß√£o Divina (+2 Arm/Res)
                // J√° vamos aplicar direto nos stats base para simplificar
                if (dados.raca === 'Celestial') {
                    stats.armadura += 2;
                    stats.resistencia += 2;
                }

                setJogador({
                    nome: dados.nome, raca: dados.raca, classe: dados.classe,
                    nivel: 1, xp: 0, proximoXp: 100,
                    hp: 20 + (stats.resistencia * 5) + hpExtra, maxHp: 20 + (stats.resistencia * 5) + hpExtra,
                    mana: 10 + (stats.resistencia * 5) + manaExtra, maxMana: 10 + (stats.resistencia * 5) + manaExtra,
                    ouro: 70, local: "Vila Verdejante", atributosBase: stats,
                    pontosAtributo: 0, // Pontos livres para distribuir
                    equipamento: { arma: null, armadura: null, acessorio: null },
                    magias: [], inventario: [],
                    rankGuilda: 'F', missoesCompletas: 0, missaoAtiva: null
                });
                setSaveId(null); // Novo jogo n√£o tem ID ainda
                setMonstros([]); // Resetar monstros antigos
                setMissoesDisponiveis([]); // Resetar miss√µes da guilda
                setLogs([]); // Limpar logs antigos
                setView('jogo');
                addLog(`Bem-vindo, ${dados.classe} ${dados.nome}!`);
            };

            // Recalcula atributos totais (Base + Equipamentos)
            const getAtributosTotais = (logicaJogador = jogador) => {
                if (!logicaJogador) return { forca: 0, habilidade: 0, resistencia: 0, armadura: 0, poderDeFogo: 0 };
                let final = { ...logicaJogador.atributosBase };

                // Soma bonus dos equipamentos
                Object.values(logicaJogador.equipamento).forEach(item => {
                    if (item && item.bonus) {
                        Object.keys(item.bonus).forEach(k => {
                            final[k] = (final[k] || 0) + item.bonus[k];
                        });
                    }
                });
                return final;
            };

            // OBS: Vamos usar essa fun√ß√£o helpers onde precisarmos dos status para calculo de dano
            const atributos = React.useMemo(() => getAtributosTotais(jogador), [jogador]);

            // --- Gerenciamento de Invent√°rio ---
            const comprarItem = (item) => {
                if (jogador.ouro < item.preco) return addLog("Ouro insuficiente.");

                const consumivel = item.tipo === 'Consumivel';
                if (consumivel) {
                    // L√≥gica Instant√¢nea para Po√ß√µes (Simplifica√ß√£o: Compra e usa na hora ou guarda? Vamos guardar se for portatil)
                    // O user pediu "guardar". Entao vai pro inventario.
                }

                setJogador(p => ({
                    ...p,
                    ouro: p.ouro - item.preco,
                    inventario: [...p.inventario, { ...item, uid: Math.random() }] // UID para itens iguais n√£o bugar
                }));
                addLog(`Comprou ${item.nome}.`, 'loot');
            };

            const usarItem = (item) => {
                if (item.tipo === 'Consumivel') {
                    setJogador(p => {
                        const novoInv = p.inventario.filter(i => i.uid !== item.uid);
                        return {
                            ...p,
                            hp: item.efeito?.hp ? Math.min(p.maxHp, p.hp + item.efeito.hp) : p.hp,
                            mana: item.efeito?.mana ? Math.min(p.maxMana, p.mana + item.efeito.mana) : p.mana,
                            inventario: novoInv
                        };
                    });
                    addLog(`Usou ${item.nome}.`, 'cura');
                } else {
                    // √â equipamento
                    equiparItem(item);
                }
            };

            const equiparItem = (item) => {
                const slot = item.tipo === 'Arma' ? 'arma' : item.tipo === 'Armadura' ? 'armadura' : 'acessorio';
                if (!['arma', 'armadura', 'acessorio'].includes(slot)) return; // Caso item nao tenha tipo certo

                setJogador(p => {
                    const itemAtual = p.equipamento[slot];
                    let novoInv = p.inventario.filter(i => i.uid !== item.uid);

                    // Se ja tem algo equipado, devolve pro inventario
                    if (itemAtual) novoInv.push(itemAtual);

                    return {
                        ...p,
                        equipamento: { ...p.equipamento, [slot]: item },
                        inventario: novoInv
                    };
                });
                addLog(`Equipou ${item.nome}.`, 'info');
            };

            const desequipar = (slot) => {
                setJogador(p => {
                    const item = p.equipamento[slot];
                    if (!item) return p;
                    return {
                        ...p,
                        equipamento: { ...p.equipamento, [slot]: null },
                        inventario: [...p.inventario, item]
                    };
                });
            };

            // ... (viajar, explorar... mantem igual mas ATEN√á√ÉO: usar 'atributos' variable calculada em vez de 'jogador.atributos') ...

            const aprenderHabilidade = (habilidade) => {
                if (jogador.ouro < habilidade.custo) return addLog("Ouro insuficiente.");
                if (jogador.magias.some(m => m.id === habilidade.id)) return addLog("J√° conhece essa t√©cnica.");

                setJogador(p => ({
                    ...p,
                    ouro: p.ouro - habilidade.custo,
                    magias: [...p.magias, habilidade]
                }));
                addLog(`Aprendeu ${habilidade.nome}!`, 'magia');
            };

            // --- Helpers Visuais ---
            const getMonsterIcon = (nome) => {
                // Filtros
                const estiloBranco = { filter: 'grayscale(100%) brightness(1000%)' };
                const estiloVerde = { filter: 'hue-rotate(120deg) brightness(80%)' }; // Vermelho -> Verde
                const estiloTroll = { filter: 'sepia(100%) hue-rotate(50deg) saturate(300%)' }; // Tom terroso/verde musgo

                if (nome.includes("Drag√£o Branco")) return <span style={estiloBranco} className="drop-shadow-[0_0_15px_rgba(255,255,255,0.9)]">üêâ</span>;

                if (nome.includes("Drag√£o")) return "üêâ";
                if (nome.includes("Lobo")) return "üê∫";

                // Yeti agora como Macaco Branco
                if (nome.includes("Yeti")) return <span style={estiloBranco}>ü¶ç</span>;

                if (nome.includes("Elemental de Gelo")) return "‚ùÑÔ∏è";
                if (nome.includes("Elemental")) return <span className="animate-spin text-cyan-200 inline-block">üåÄ</span>;

                // Guerreiro N√≥rdico Branco
                if (nome.includes("Guerreiro N√≥rdico")) return <span style={estiloBranco}>üò†</span>;

                // Aranha antes de Gigante para "Aranha Gigante" funcionar
                if (nome.includes("Aranha")) return "üï∑Ô∏è";

                // Prioridade para P√¢ntano (Cobra/Crocodilo)
                if (nome.includes("Cobra") || nome.includes("Serpente")) return "üêç";
                if (nome.includes("Crocodilo")) return "üêä";
                if (nome.includes("Slime")) return "üß™";

                if (nome.includes("Gigante")) return "ü•∂";

                // Goblins e Orcs Verdes
                if (nome.includes("Goblin")) return <span style={estiloVerde}>üë∫</span>;
                // Troll (Verde)
                if (nome.includes("Troll")) return <span style={{ filter: 'hue-rotate(120deg)' }}>üëπ</span>;

                if (nome.includes("Esqueleto") || nome.includes("Espectro")) return "üíÄ";
                if (nome.includes("Guerreiro") || nome.includes("Bandido")) return "üò†";
                if (nome.includes("Urso")) return "üêª";
                if (nome.includes("Javali")) return "üêó"; // Novo
                if (nome.includes("Cobra") || nome.includes("Serpente")) return ""; // Novo
                if (nome.includes("Crocodilo")) return "üêä"; // Novo
                if (nome.includes("Slime")) return "üß™"; // Novo (ou ü¶†)
                if (nome.includes("Rato") || nome.includes("Ratataz")) return "üêÄ";
                if (nome.includes("Golem")) return "üóø";

                return "üëæ";
            };

            // --- A√ß√µes de Jogo ---
            // --- A√ß√µes de Jogo ---
            const explorar = () => {
                if (jogador.hp <= 0) return addLog("Voc√™ est√° desmaiado!", 'perigo');

                // L√≥gica de Encontro (70% nada, 30% monstro) - Ajustado para teste: 50%
                if (Math.random() > 0.5) {
                    // Combate!
                    // Chance de virar uma batalha em grupo (30%)
                    const qtdMonstros = Math.random() > 0.7 ? (Math.random() > 0.6 ? 3 : 2) : 1;

                    const novosMonstros = [];
                    for (let i = 0; i < qtdMonstros; i++) {
                        const m = Gerador.monstro(jogador.nivel, jogador.local);
                        m.uid = Date.now() + i; // ID √∫nico para controle React
                        novosMonstros.push(m);
                    }

                    setMonstros(novosMonstros);
                    addLog(`Voc√™ encontrou ${qtdMonstros > 1 ? 'um grupo de inimigos!' : 'um inimigo!'}`, 'perigo');
                } else {
                    // Evento de Explora√ß√£o (Item, Ouro ou Nada)
                    const sorte = Math.random();
                    if (sorte > 0.7) {
                        const ouroAchado = Math.floor(Math.random() * 20 * jogador.nivel) + 10;
                        setJogador(p => ({ ...p, ouro: p.ouro + ouroAchado }));
                        addLog(`Encontrou ${ouroAchado} ouro!`, 'loot');
                    } else if (sorte > 0.9) {
                        // Drop de item simples (Po√ß√£o)
                        const pocao = { id: 'pocao_vida', nome: "Po√ß√£o de Vida", tipo: "Consum√≠vel", efeito: "Cura 50 PV", valor: 50 };
                        // Simplifica√ß√£o: Adiciona direto (futuro: invent√°rio real)
                        addLog("Encontrou uma Po√ß√£o de Vida! (N√£o implementado invent√°rio full ainda)", 'loot');
                    } else {
                        addLog("Explorou a √°rea mas n√£o encontrou nada.", 'comum');
                    }
                }
            };

            const usarHabilidade = (habilidade) => {
                const custo = habilidade.mana;
                if (jogador.mana < custo) return addLog("Energia/Mana insuficiente!", 'perigo');

                const ehAtaque = ['Ataque', 'F√≠sico', 'M√°gico'].includes(habilidade.tipo);
                if (monstros.length === 0 && ehAtaque) return addLog("N√£o h√° inimigos para atacar.");

                // Efeito
                if (habilidade.tipo === 'Cura') {
                    const cura = Math.floor(habilidade.poder * (jogador.nivel / 2 + 1) + atributos.poderDeFogo);
                    setJogador(p => ({
                        ...p,
                        hp: Math.min(p.maxHp, p.hp + cura),
                        mana: p.mana - custo
                    }));
                    addLog(`Usou ${habilidade.nome} e recuperou ${cura} PV.`, 'cura');
                } else if (ehAtaque) {
                    const alvoIndex = 0;
                    const alvo = monstros[alvoIndex];

                    // C√°lculo de Dano: F√≠sico vs M√°gico
                    let atributoBonus = atributos.poderDeFogo;
                    if (habilidade.tipo === 'F√≠sico') {
                        atributoBonus = Math.max(atributos.forca, atributos.habilidade); // Usa o maior entre For√ßa e Destreza
                    }

                    const danoBase = Math.floor(habilidade.poder + atributoBonus);
                    const dano = Math.floor(danoBase * (1 + Math.random() * 0.2)); // Varia√ß√£o de 20%

                    addLog(`Usou ${habilidade.nome} em ${alvo.nome} causando ${dano} de dano!`, 'magia');

                    const novoHpAlvo = alvo.hp - dano;
                    let novosMonstros = monstros.map((m, i) => i === alvoIndex ? { ...m, hp: novoHpAlvo } : m);

                    if (novoHpAlvo <= 0) {
                        addLog(`${alvo.nome} foi derrotado!`, 'sucesso');

                        if (campeonatoAtivo) {
                            avancarRodadaCampeonato();
                            setJogador(p => ({ ...p, mana: p.mana - custo })); // Consome mana mesmo se matar
                            return;
                        }

                        // L√≥gica de Kill (XP, Drops, Level Up) - Simplificada para n√£o duplicar c√≥digo
                        // Idealmente deveria ser uma fun√ß√£o helper `processarKill(alvo)`
                        setJogador(p => {
                            let gainXp = alvo.xp;
                            if (p.raca === 'Humano') gainXp = Math.floor(gainXp * 1.10);

                            let novaXp = p.xp + gainXp;
                            let novoNivel = p.nivel;
                            let novoProximoXp = p.proximoXp;
                            let msgLevelUp = "";

                            if (p.nivel >= NIVEL_MAX_CLASSE_BASICA && !p.classeEvoluida) {
                                if (novaXp >= p.proximoXp) novaXp = p.proximoXp - 1;
                            }

                            if (novaXp >= p.proximoXp) {
                                novoNivel++;
                                novaXp = novaXp - p.proximoXp;
                                novoProximoXp = Math.floor(p.proximoXp * 1.5);
                                msgLevelUp = `LEVEL UP! N√≠vel ${novoNivel}!`;
                                addLog(msgLevelUp, 'sucesso');
                                setTimeout(() => setModal('levelup'), 500);
                            }

                            const hpFinal = msgLevelUp ? p.maxHp + 10 : p.hp;
                            const maxHpFinal = msgLevelUp ? p.maxHp + 10 : p.maxHp;

                            return {
                                ...p,
                                xp: novaXp,
                                ouro: p.ouro + alvo.ouro,
                                nivel: novoNivel,
                                proximoXp: novoProximoXp,
                                pontosAtributo: msgLevelUp ? (p.pontosAtributo || 0) + 1 : (p.pontosAtributo || 0),
                                hp: hpFinal,
                                maxHp: maxHpFinal,
                                mana: Math.max(0, (msgLevelUp ? p.maxMana + 5 : p.mana) - custo),
                                maxMana: msgLevelUp ? p.maxMana + (p.raca === 'Elfo' ? 6 : 5) : p.maxMana
                            };
                        });

                        novosMonstros = novosMonstros.filter((_, i) => i !== alvoIndex);
                    } else {
                        // Se n√£o matou, consome mana normal
                        setJogador(p => ({ ...p, mana: p.mana - custo }));
                    }

                    // Contra-ataque simples se houver sobreviventes
                    if (novosMonstros.length > 0) {
                        let danoTotal = 0;
                        novosMonstros.forEach(m => {
                            const danoM = Math.max(1, m.dano - atributos.armadura);
                            danoTotal += danoM;
                            addLog(`${m.nome} atacou! -${danoM} PV`, 'perigo');
                        });
                        if (danoTotal > 0) setJogador(p => ({ ...p, hp: Math.max(0, p.hp - danoTotal) }));
                    }
                    setMonstros(novosMonstros);

                } else if (['Buff', 'DoT', 'Transform', 'Summon'].includes(habilidade.tipo)) {
                    addLog(`Usou ${habilidade.nome}! (Efeito especial em breve)`, 'magia');
                    // Efeito placeholder: Recupera um pouco de mana para n√£o gastar √† toa? N√£o, gasta.
                    setJogador(p => ({ ...p, mana: p.mana - custo }));
                }
            };

            const fugir = () => {
                if (monstros.length === 0) return;

                // Chance Base: 50% + (Habilidade * 5%)
                // Ex: Hab 1 = 55%, Hab 5 = 75%
                const chance = 0.5 + (atributos.habilidade * 0.05);

                // Rolagem
                if (Math.random() < chance) {
                    addLog("Voc√™ fugiu com sucesso! üèÉüí®", 'sucesso');
                    setMonstros([]);
                    // setIndiceAlvo n√£o existe nesta vers√£o simplificada
                } else {
                    addLog("Falha ao fugir! Voc√™ trope√ßou... üò±", 'perigo');
                    // Perde o turno, monstros atacam (L√≥gica inline, pois turnoMonstro n√£o existe como func)
                    let danoTotal = 0;
                    monstros.forEach(m => {
                        // Dano do monstro x Armadura do Jogador
                        const danoM = Math.max(1, m.dano - atributos.armadura);
                        danoTotal += danoM;
                        addLog(`${m.nome} atacou! -${danoM} PV`, 'perigo');
                    });

                    if (danoTotal > 0) {
                        setJogador(p => ({ ...p, hp: Math.max(0, p.hp - danoTotal) }));
                    }
                }
            };

            const atacar = () => {
                if (monstros.length === 0) return;

                // Ataca o primeiro monstro da fila (alvo) - Simplifica√ß√£o: Sempre o primeiro
                const alvoIndex = 0;
                const alvo = monstros[alvoIndex];

                // Dano Jogador -> Monstro
                // Balanceamento: Usa o MAIOR atributo (For√ßa, Habilidade ou PdF) para n√£o punir Magos/Arqueiros
                const atributoOfensivo = Math.max(atributos.forca, atributos.habilidade, atributos.poderDeFogo);
                let dano = Math.floor(atributoOfensivo + (Math.random() * 3));

                // Tra√ßo Racial: Orc (F√∫ria)
                if (jogador.raca === 'Orc') {
                    dano += 2; // +2 Dano Fixo
                }

                const novoHpAlvo = alvo.hp - dano;

                addLog(`Voc√™ causou ${dano} de dano em ${alvo.nome}.`);

                // Prepara lista de monstros para o pr√≥ximo estado (atualizando o alvo)
                let novosMonstros = monstros.map((m, i) => i === alvoIndex ? { ...m, hp: novoHpAlvo } : m);

                // Verifica morte do alvo
                if (novoHpAlvo <= 0) {
                    addLog(`${alvo.nome} foi derrotado!`, 'sucesso');

                    if (campeonatoAtivo) {
                        avancarRodadaCampeonato();
                        return; // Encerra ataque
                    }

                    // Drops e XP
                    setJogador(p => {
                        let gainXp = alvo.xp;

                        // Tra√ßo Racial: Humano (Prod√≠gio)
                        if (p.raca === 'Humano') {
                            gainXp = Math.floor(gainXp * 1.10); // +10% XP
                        }

                        let novaXp = p.xp + gainXp;
                        let novoNivel = p.nivel;
                        let novoProximoXp = p.proximoXp;
                        let msgLevelUp = "";

                        // L√≥gica de Trava de N√≠vel
                        if (p.nivel >= NIVEL_MAX_CLASSE_BASICA && !p.classeEvoluida) {
                            if (novaXp >= p.proximoXp) {
                                novaXp = p.proximoXp - 1;
                                addLog(`N√≠vel M√°ximo (${NIVEL_MAX_CLASSE_BASICA}) atingido! V√° √† Guilda para evoluir.`, 'perigo');
                            }
                        }

                        if (novaXp >= p.proximoXp) {
                            novoNivel++;
                            novaXp = novaXp - p.proximoXp; // Zera a barra (sobra o overflow)
                            novoProximoXp = Math.floor(p.proximoXp * 1.5);
                            msgLevelUp = `LEVEL UP! N√≠vel ${novoNivel}! (+1 Ponto de Atributo)`;
                            addLog(msgLevelUp, 'sucesso');
                            setTimeout(() => setModal('levelup'), 500); // Trigger modal
                        }

                        // Cura no level up
                        const hpFinal = msgLevelUp ? p.maxHp + 10 : p.hp;
                        const maxHpFinal = msgLevelUp ? p.maxHp + 10 : p.maxHp;

                        return {
                            ...p,
                            xp: novaXp,
                            ouro: p.ouro + alvo.ouro,
                            nivel: novoNivel,
                            proximoXp: novoProximoXp,
                            pontosAtributo: msgLevelUp ? (p.pontosAtributo || 0) + 1 : (p.pontosAtributo || 0), // Ganha 1 ponto
                            hp: hpFinal,
                            maxHp: maxHpFinal,
                            mana: msgLevelUp ? p.maxMana + 5 : p.mana, // Recupera mana no lvl up
                            maxMana: msgLevelUp ? p.maxMana + (p.raca === 'Elfo' ? 6 : 5) : p.maxMana // Elfo ganha +1 Mapa por nivel (Trait)
                        };
                    });

                    // Drop Chance
                    if (alvo.drop && Math.random() > 0.4) {
                        const itemDrop = {
                            id: Date.now(),
                            nome: alvo.drop,
                            tipo: "Material",
                            desc: `Obtido de ${alvo.nome}`
                        };
                        if (alvo.drop.includes("L√¢mina") || alvo.drop.includes("Armadura") || alvo.drop.includes("Machado")) {
                            itemDrop.tipo = "Equipamento";
                            itemDrop.bonus = alvo.drop.includes("Armadura") ? { armadura: 5 } : { forca: 5 };
                        }
                        setJogador(p => ({ ...p, inventario: [...p.inventario, itemDrop] }));
                        addLog(`Drop: ${alvo.drop}`, 'loot');
                    }

                    if (jogador.missaoAtiva) {
                        // Miss√£o Normal de Eliminar
                        // Match mais flex√≠vel: verifica se o nome do monstro (parte dele) est√° na descri√ß√£o ou t√≠tulo
                        if (jogador.missaoAtiva.titulo.includes("Eliminar") && (jogador.missaoAtiva.titulo.includes(alvo.nome) || alvo.nome.includes(jogador.missaoAtiva.titulo.split(" ")[1].slice(0, -1)))) {
                            // Tenta match simples da palavra chave (ex: "Goblin" em "Eliminar Goblins")
                            // A logica acima √© meio complexa, vamos simplificar no update do gerador para usar singular
                            // Gerador agora usa Singular. "Eliminar Goblins". Title split [1] = "Goblins". Slice 0,-1 = "Goblin".
                            // Alvo nome "Goblin Saqueador". Includes "Goblin"? Sim.
                            setJogador(p => {
                                const missao = p.missaoAtiva;
                                const atualizado = { ...missao, atual: Math.min(missao.atual + 1, missao.req) };
                                if (atualizado.atual >= atualizado.req && missao.atual < missao.req) {
                                    addLog("Miss√£o Cumprida! Volte √† guilda.", 'sucesso');
                                }
                                return { ...p, missaoAtiva: atualizado };
                            });
                        }
                        // Miss√£o de Evolu√ß√£o (Qualquer inimigo conta, ou s√≥ Boss? Vamos fazer qualquer um por enquanto pra ser "Derrote 5 inimigos poderosos" -> "Derrote 5 inimigos")
                        if (jogador.missaoAtiva.tipo === 'evolucao') {
                            setJogador(p => {
                                const missao = p.missaoAtiva;
                                const atualizado = { ...missao, atual: Math.min(missao.atual + 1, missao.req) };
                                if (atualizado.atual >= atualizado.req && missao.atual < missao.req) {
                                    addLog("Prova√ß√£o Completa! Volte √† guilda para evoluir!", 'sucesso');
                                }
                                return { ...p, missaoAtiva: atualizado };
                            });
                        }
                    }

                    // Remove o morto
                    novosMonstros = novosMonstros.filter((_, i) => i !== alvoIndex);
                }

                // Contra-Ataque dos Sobreviventes
                let danoTotal = 0;
                novosMonstros.forEach(m => {
                    const danoM = Math.max(1, m.dano - atributos.armadura);
                    danoTotal += danoM;
                    addLog(`${m.nome} atacou! -${danoM} PV`, 'perigo');
                });

                if (danoTotal > 0) {
                    setJogador(p => {
                        const novoHp = Math.max(0, p.hp - danoTotal);
                        if (novoHp <= 0) {
                            addLog("VOC√ä MORREU...", 'perigo');
                            setTimeout(respawn, 2000);
                        }
                        return { ...p, hp: novoHp };
                    });
                }

                setMonstros(novosMonstros);

                if (novosMonstros.length === 0 && monstros.length > 0) { // Se matou o √∫ltimo
                    addLog("Todos os inimigos foram derrotados!", 'sucesso');
                }
            };

            const viajar = (local) => {
                const custo = 20 + (jogador.nivel * 5);
                if (jogador.ouro < custo) return addLog("Sem ouro para a carruagem!");

                setModal(null);
                setMonstros([]);
                setJogador(p => ({ ...p, local: local.nome, ouro: p.ouro - custo }));
                addLog(`Viajou para ${local.nome}. (-${custo} Ouro)`);
            };

            const abrirGuilda = () => {
                if (missoesDisponiveis.length === 0) {
                    setMissoesDisponiveis([Gerador.missao(jogador.rankGuilda), Gerador.missao(jogador.rankGuilda), Gerador.missao(jogador.rankGuilda)]);
                }

                // Check se precisa de miss√£o de evolu√ß√£o
                if (jogador.nivel >= NIVEL_MAX_CLASSE_BASICA && !jogador.classeEvoluida && !jogador.missaoAtiva) {
                    const missaoEvolucao = {
                        id: 'evolucao',
                        titulo: 'A Prova√ß√£o do Mestre',
                        desc: `Para se tornar um ${EVOLUCOES[jogador.classe]}, voc√™ deve provar seu valor. Derrote 5 inimigos poderosos.`,
                        rank: 'S',
                        req: 5,
                        atual: 0,
                        xp: 0,
                        ouro: 1000,
                        tipo: 'evolucao'
                    };
                    // Se n√£o tiver a miss√£o de evolu√ß√£o na lista, adiciona no topo
                    setMissoesDisponiveis(prev => {
                        if (prev.some(m => m.tipo === 'evolucao')) return prev;
                        return [missaoEvolucao, ...prev];
                    });
                }

                setModal('guilda');
            };

            const REQUISITOS_RANK = [3, 8, 15, 25, 40, 60, 100]; // F->E, E->D...

            const cancelarMissao = () => {
                if (!confirm("Cancelar miss√£o atual? Todo o progresso ser√° perdido.")) return;
                setJogador(p => ({ ...p, missaoAtiva: null }));
                addLog("Miss√£o cancelada.", 'perigo');
            };

            const respawn = () => {
                setJogador(p => {
                    const penaOuro = Math.floor(p.ouro * 0.1);
                    const penaXp = Math.floor(p.xp * 0.1);

                    // Log aqui dentro pode duplicar em StrictMode, mas √© visual. 
                    // Melhor: setar log fora ou ignorar. Vamos manter o log fora com valores estimados ou fazer calculo fora e passar (o bug original podia ser stale state).
                    // Se o usu√°rio clicava muito r√°pido, podia enfileirar.

                    return {
                        ...p,
                        hp: Math.floor(p.maxHp * 0.5),
                        ouro: p.ouro - penaOuro,
                        xp: p.xp - penaXp,
                        local: "Vila Verdejante"
                    };
                });
                setMonstros([]);
                addLog(`Voc√™ foi resgatado e levado √† Vila. (Pena: -10% Ouro/XP)`, 'perigo');
            };

            const abrirTaverna = () => setModal('taverna');

            const acaoTaverna = (tipo) => {
                const custoBebida = Math.ceil(jogador.nivel * 2);
                const custoDescanso = Math.ceil(jogador.nivel * 15);

                if (tipo === 'bebida') {
                    if (jogador.ouro < custoBebida) return addLog("Sem ouro para beber!");
                    setJogador(p => ({
                        ...p,
                        ouro: p.ouro - custoBebida,
                        mana: Math.min(p.maxMana, p.mana + 10),
                        hp: Math.min(p.maxHp, p.hp + 5)
                    }));
                    addLog("Glup! Cerveja boa. (+5 PV, +10 PM)", 'sucesso');
                } else if (tipo === 'descanso') {
                    if (jogador.ouro < custoDescanso) return addLog("Sem ouro para o quarto!");
                    setJogador(p => ({
                        ...p,
                        ouro: p.ouro - custoDescanso,
                        hp: p.maxHp,
                        mana: p.maxMana
                    }));
                    addLog("Voc√™ dormiu como uma pedra. Energias renovadas!", 'sucesso');
                    setModal(null);
                }
            };

            const aceitarMissao = (missao) => {
                if (jogador.missaoAtiva) return addLog("J√° possui uma miss√£o ativa!");
                setJogador(p => ({ ...p, missaoAtiva: missao }));
                setMissoesDisponiveis(p => p.filter(m => m.id !== missao.id));
                setModal(null);
                addLog(`Aceitou a miss√£o: ${missao.titulo}`);
            };

            // --- SISTEMA DE SAVE/LOAD 2.0 ---
            const getSaves = () => {
                const saved = localStorage.getItem(STORAGE_KEY_V2);
                return saved ? JSON.parse(saved) : [];
            };

            const salvarJogo = (salvarComo = false) => {
                let nomeSave = `Save ${jogador.nivel} - ${jogador.classe}`;
                let idParaSalvar = saveId;

                // Se for "Salvar Como" ou se for o primeiro save (sem ID), cria novo
                if (salvarComo || !idParaSalvar) {
                    nomeSave = prompt("Nome do Save:", nomeSave);
                    if (!nomeSave) return;
                    idParaSalvar = Date.now();
                }

                const novoSave = {
                    id: idParaSalvar,
                    nome: nomeSave, // Nota: Se sobrescrever, mantemos o nome original ou atualizamos? Simplifica√ß√£o: Se saveComo, usa novo nome. Se overwrite, usa nome antigo? N√£o, overwrite update timestamp mas nome mantem ou n√£o? 
                    // Melhor: overwrite mantem o mesmo ID. O nome pode ser atualizado se quisermos, mas como nao pedimos input, mantem o que estava?
                    // Na logica abaixo, se overwrite, a gente n√£o pediu nome. Ent√£o precisamos pegar o nome do save atual se ele existir, ou usar o gerado.
                    // Ajuste: Se overwrite, n√£o pede nome, ent√£o usa o nome que j√° estava no save OU gera um default.
                    // Vamos simplificar: Overwrite atualiza os DADOS e DATA, mantendo ID. Nome vamos manter o do save original se possivel, ou atualizar para "Lv X Class".
                    // Como n√£o temos o nome antigo facil aqui sem buscar, vamos assumir que o usuario nao quer mudar nome no overwrite.

                    data: new Date().toISOString(),
                    dados: {
                        jogador: jogador,
                        missoesDisponiveis: missoesDisponiveis,
                        logs: logs,
                        campeonato: {
                            disponivel: campeonatoDisponivel,
                            tempo: tempoAteCampeonato,
                            rodada: rodadaCampeonato,
                            ativo: campeonatoAtivo
                        }
                    }
                };

                const saves = getSaves();

                if (salvarComo || !saveId) {
                    // Novo Save
                    // Novo ID ja gerado acima
                    saves.unshift(novoSave);
                    if (saves.length > 10) saves.pop();
                    addLog("Novo save criado!", 'sucesso');
                } else {
                    // Sobrescrever
                    const index = saves.findIndex(s => s.id === idParaSalvar);
                    if (index !== -1) {
                        // Preserva o nome original se for overwrite, a menos que queiramos atualizar status
                        novoSave.nome = saves[index].nome;
                        saves.splice(index, 1); // Remove antigo
                        saves.unshift(novoSave); // Adiciona atualizado no topo
                        addLog("Jogo salvo com sucesso!", 'sucesso');
                    } else {
                        // Fallback: ID perdido, salva como novo
                        saves.unshift(novoSave);
                        addLog("ID n√£o encontrado. Salvo como novo arquivo.", 'sucesso');
                    }
                }

                localStorage.setItem(STORAGE_KEY_V2, JSON.stringify(saves));
                setVersaoSave(v => v + 1);
                setSaveId(idParaSalvar); // Atualiza ID atual
                setModal(null);
            };

            const deletarSave = (id) => {
                if (!confirm("Tem certeza que deseja deletar este save?")) return;
                const saves = getSaves().filter(s => s.id !== id);
                localStorage.setItem(STORAGE_KEY_V2, JSON.stringify(saves));
                setVersaoSave(v => v + 1);
            };

            // --- IMPORTAR / EXPORTAR ARQUIVO ---
            const exportarArquivo = () => {
                const saves = getSaves();
                if (saves.length === 0) return alert("Nenhum save para exportar!");

                // Pega o save mais recente (ou todos? Vamos exportar TODOS para garantir backup full)
                const dataStr = JSON.stringify(saves);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

                const exportFileDefaultName = `cronicas-rpg-backup-${new Date().toISOString().slice(0, 10)}.rpgsave`;

                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                addLog("Arquivo de save baixado com sucesso!", "sucesso");
            };

            const importarArquivo = (event) => {
                const fileObj = event.target.files && event.target.files[0];
                if (!fileObj) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        console.log("Tentando importar save...");
                        const json = JSON.parse(e.target.result);

                        // Valida√ß√£o b√°sica: deve ser um array OU um objeto √∫nico (para compatibilidade futura/passada)
                        let savesValidos = [];

                        if (Array.isArray(json)) {
                            savesValidos = json;
                        } else if (typeof json === 'object' && json !== null) {
                            // Se o usu√°rio upou um √∫nico save object, encapsula em array
                            savesValidos = [json];
                        } else {
                            throw new Error("Formato inv√°lido: O arquivo deve conter um JSON.");
                        }

                        // Verifica se tem pelo menos um save com estrutura m√≠nima
                        // Estrutura V2: { id, nome, dados: { jogador: {...} } }
                        // Estrutura V1 (Legado/Bug): { id, nome, jogador: {...} } -> Se existir, vamos adaptar

                        // Tentativa de corre√ß√£o autom√°tica para formatos antigos ou corrompidos
                        savesValidos = savesValidos.map(s => {
                            if (!s.dados && s.jogador) {
                                // Migrar formato plano para aninhado
                                return {
                                    ...s,
                                    dados: {
                                        jogador: s.jogador,
                                        missoesDiponiveis: s.missoesDiponiveis || [],
                                        logs: s.logs || []
                                    }
                                };
                            }
                            return s;
                        });

                        // Valida√ß√£o Final: Primeiro save deve ter jogador
                        if (!savesValidos[0] || !savesValidos[0].dados || !savesValidos[0].dados.jogador) {
                            console.error("Conte√∫do do JSON inv√°lido:", json);
                            throw new Error("Dados corrompidos ou formato incompat√≠vel. (Objeto jogador n√£o encontrado)");
                        }

                        // Salva
                        localStorage.setItem(STORAGE_KEY_V2, JSON.stringify(savesValidos));
                        setVersaoSave(v => v + 1);
                        alert("Backup restaurado com sucesso! Clique em 'Continuar' para jogar.");

                    } catch (err) {
                        console.error("Erro no import:", err);
                        alert("Erro ao ler arquivo: " + err.message);
                    }
                };
                reader.readAsText(fileObj);
            };

            // Input Ref para ativar o file dialog via bot√£o customizado
            const fileInputRef = React.useRef(null);
            const triggerImport = () => fileInputRef.current.click();



            const carregarSaveEspecifico = (saveData) => {
                // Compatibilidade com saves antigos (flat vs nested in dados)
                const dados = saveData.dados || saveData; // Se n√£o tiver .dados, assume que √© o pr√≥prio objeto (formato antigo/bugado)

                if (dados.jogador) {
                    setJogador(dados.jogador);
                    setMissoesDisponiveis(dados.missoesDisponiveis || dados.missoesDiponiveis || []);
                    setLogs(dados.logs || []);

                    // Restaurar Campeonato (com default seguro)
                    if (dados.campeonato) {
                        setCampeonatoDisponivel(dados.campeonato.disponivel);
                        setTempoAteCampeonato(dados.campeonato.tempo);
                        setRodadaCampeonato(dados.campeonato.rodada);
                        setCampeonatoAtivo(dados.campeonato.ativo);
                    } else {
                        // Save antigo sem dados do camp -> Reseta para evitar bugs
                        setCampeonatoDisponivel(false);
                        setTempoAteCampeonato(600);
                        setRodadaCampeonato(0);
                        setCampeonatoAtivo(false);
                    }
                    setView('jogo');
                    setSaveId(saveData.id); // Registra que estamos jogando este save
                    setModal(null);
                    addLog(`Jogo carregado: ${saveData.nome}`, 'sucesso');
                } else {
                    alert("Erro: Save corrompido ou incompat√≠vel.");
                }
            };

            const continuarJogo = () => {
                const saves = getSaves();
                if (saves.length > 0) {
                    carregarSaveEspecifico(saves[0]); // O primeiro √© sempre o mais recente
                }
            };

            const abrirMenuCarregar = () => {
                setModal('carregar_menu');
            };

            const carregarJogo = () => {
                // Fun√ß√£o antiga de carregar bot√£o in-game agora abre o menu de saves
                setModal('carregar_menu');
            };

            const reiniciarJogo = () => {
                if (confirm("Voltar ao Menu Principal? O progresso n√£o salvo ser√° perdido.")) {
                    setView('landing'); // Volta pra Landing
                    setModal(null);
                }
            };

            const iniciarCampeonato = () => {
                if (!campeonatoDisponivel) return;

                setCampeonatoAtivo(true);
                setRodadaCampeonato(1);
                setModal(null);

                // Helper para gerar inimigo de campeonato
                const gerarInimigoArena = (rodada) => {
                    // 1. Bioma Aleat√≥rio (Excluindo cidades iniciais para mais emo√ß√£o)
                    const biomasArena = LOCAIS_FIXOS.filter(l => l.tipo !== 'Vila' && l.tipo !== 'Cidade').map(l => l.nome);
                    const biomaSorteado = biomasArena[Math.floor(Math.random() * biomasArena.length)] || "Bosque Ancestral";

                    const mobBase = Gerador.monstro(jogador.nivel, biomaSorteado);

                    // 2. T√≠tulo Aleat√≥rio
                    const titulos = ['Gladiador', 'Veterano', 'Algoz', 'Destruidor', 'Mercen√°rio', 'Ca√ßador'];
                    const titulosEpicos = ['A Lenda', 'O Imortal', 'O Imperador', 'O Ceifador', 'A Besta'];

                    let prefixo = titulos[Math.floor(Math.random() * titulos.length)];
                    let isEpico = false;

                    if (rodada === 5) {
                        prefixo = titulosEpicos[Math.floor(Math.random() * titulosEpicos.length)];
                        isEpico = true;
                    }

                    mobBase.nome = `${prefixo} ${mobBase.nome}`;

                    // 3. Escala
                    // Rodada 1: 1.2x
                    // Rodada 5: 2.0x + Boss Boost
                    const escala = 1.0 + (rodada * 0.2);

                    mobBase.hp = Math.floor(mobBase.hp * (isEpico ? escala * 1.5 : escala));
                    mobBase.maxHp = mobBase.hp;
                    mobBase.dano = Math.floor(mobBase.dano * (isEpico ? escala * 1.2 : escala));
                    mobBase.xp = Math.floor(mobBase.xp * (isEpico ? 4 : 2));
                    mobBase.ouro = Math.floor(mobBase.ouro * (isEpico ? 4 : 2));
                    mobBase.uid = Date.now();

                    return mobBase;
                };

                const inimigo = gerarInimigoArena(1);
                setMonstros([inimigo]);
                addLog("üèÜ O CAMPEONATO COME√áOU! PREPARE-SE!", 'loot');
                addLog(`Inimigo vindo de: ${LOCAIS_FIXOS.find(l => POOLS[l.nome]?.some(p => inimigo.nome.includes(p.nome)))?.bioma || 'Mundo Selvagem'}`, 'comum'); // Tentativa de fluff
            };

            const avancarRodadaCampeonato = () => {
                if (rodadaCampeonato >= 5) {
                    // Vit√≥ria Final
                    const bonusOuro = 500 * jogador.nivel;
                    const bonusXp = 200 * jogador.nivel;

                    setJogador(p => ({
                        ...p,
                        ouro: p.ouro + bonusOuro,
                        xp: p.xp + bonusXp
                    }));

                    addLog(`üèÜ CAMPE√ÉO! Voc√™ venceu o torneio!`, 'sucesso');
                    addLog(`Recebeu ${bonusOuro} Ouro e ${bonusXp} XP extra!`, 'loot');
                    alert(`PARAB√âNS! VOC√ä √â O CAMPE√ÉO DA ARENA!\n\nPr√™mios:\nüí∞ ${bonusOuro} Ouro\n‚ú® ${bonusXp} XP`);

                    setCampeonatoAtivo(false);
                    setRodadaCampeonato(0);
                    setCampeonatoDisponivel(false); // Fecha o evento
                    setTempoAteCampeonato(600); // Reset timer
                } else {
                    // Pr√≥xima Rodada
                    setRodadaCampeonato(p => p + 1);
                    const novaRodada = rodadaCampeonato + 1;
                    addLog(`üîî RODADA ${novaRodada}/5 COME√áOU!`, 'comum');

                    // Reutilizar l√≥gica de gera√ß√£o (replicada aqui ou mover para fora? Mover para fora seria ideal mas requer refatorar o escopo. Vou replicar inline melhorado)
                    // ... Melhor: extrair o gerador para uma const fora? N√£o tem acesso a LOCAIS_FIXOS se for fora do componente? Tem sim.
                    // Mas dentro de iniciarCampeonato a fun√ß√£o n√£o √© visivel aqui.
                    // VOU COPIAR A LOGICA AQUI PARA GARANTIR FUNCIONAMENTO R√ÅPIDO.

                    const biomasArena = LOCAIS_FIXOS.filter(l => l.tipo !== 'Vila' && l.tipo !== 'Cidade').map(l => l.nome);
                    const biomaSorteado = biomasArena[Math.floor(Math.random() * biomasArena.length)] || "Bosque Ancestral";

                    const mobBase = Gerador.monstro(jogador.nivel, biomaSorteado);

                    const titulos = ['Gladiador', 'Veterano', 'Algoz', 'Destruidor', 'Mercen√°rio', 'Ca√ßador'];
                    const titulosEpicos = ['A Lenda', 'O Imortal', 'O Imperador', 'O Ceifador', 'A Besta'];

                    let prefixo = titulos[Math.floor(Math.random() * titulos.length)];
                    let isEpico = false;

                    if (novaRodada === 5) {
                        prefixo = titulosEpicos[Math.floor(Math.random() * titulosEpicos.length)];
                        isEpico = true;
                    }

                    mobBase.nome = `${prefixo} ${mobBase.nome}`;

                    const escala = 1.0 + (novaRodada * 0.2);

                    mobBase.hp = Math.floor(mobBase.hp * (isEpico ? escala * 1.5 : escala));
                    mobBase.maxHp = mobBase.hp;
                    mobBase.dano = Math.floor(mobBase.dano * (isEpico ? escala * 1.2 : escala));
                    mobBase.xp = Math.floor(mobBase.xp * (isEpico ? 4 : 2));
                    mobBase.ouro = Math.floor(mobBase.ouro * (isEpico ? 4 : 2));
                    mobBase.uid = Date.now();

                    setMonstros([mobBase]);

                    // Pequena cura entre rounds (opcional, para n√£o ser imposs√≠vel)
                    setJogador(p => ({ ...p, hp: Math.min(p.maxHp, p.hp + Math.floor(p.maxHp * 0.2)) }));
                    addLog("Recuperou um pouco de vida no intervalo...", 'cura');
                }
            };

            // Efeito inicial para verificar migra√ß√£o (se necess√°rio) ou s√≥ log
            React.useEffect(() => {
                // Verifica se tem saves antigos e migra se quiser, mas por simplicidade vamos manter v2
            }, []);

            if (view === 'menu') {
                return (
                    <>
                        <MenuPrincipal
                            onNovo={() => setView('landing')} // Bot√£o "voltar menu"
                            onContinuar={() => setView('jogo')}
                            onCarregar={abrirMenuCarregar}
                            temSave={true}
                        />
                        {/* Renderiza o modal de carregar se estiver ativo (mesmo no menu) */}
                        {modal === 'carregar_menu' && (
                            <div className="absolute inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center p-8 z-50">
                                <div className="bg-zinc-900 border border-amber-500/30 p-6 rounded-2xl w-full max-w-2xl h-full overflow-y-auto relative animate-slide-up">
                                    <button onClick={() => setModal(null)} className="absolute top-4 right-4 text-zinc-500 hover:text-white text-xl">‚úï</button>
                                    <h2 className="text-3xl font-fantasy text-amber-500 mb-6 text-center">Carregar Jogo</h2>

                                    <div className="space-y-4">
                                        {getSaves().length === 0 ? (
                                            <p className="text-center text-zinc-500 italic">Nenhum jogo salvo encontrado.</p>
                                        ) : (
                                            getSaves().map(save => (
                                                <div key={save.id} className="bg-zinc-800 p-4 rounded-xl border border-zinc-700 hover:border-amber-500 cursor-pointer transition-all flex justify-between items-center group">
                                                    <div className="flex-1" onClick={() => carregarSaveEspecifico(save)}>
                                                        <h3 className="font-bold text-lg text-zinc-200 group-hover:text-amber-400">{save.nome}</h3>
                                                        <p className="text-xs text-zinc-500">{new Date(save.data).toLocaleString()}</p>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <button onClick={(e) => { e.stopPropagation(); deletarSave(save.id); }} className="p-2 text-zinc-600 hover:text-red-500 transition-colors" title="Deletar Save">üóëÔ∏è</button>
                                                        <div className="text-2xl opacity-0 group-hover:opacity-100 transition-opacity" onClick={() => carregarSaveEspecifico(save)}>‚ñ∂Ô∏è</div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Modal de Importa√ß√£o (Hidden Input) */}
                        <input
                            type="file"
                            ref={fileInputRef}
                            style={{ display: 'none' }}
                            accept=".rpgsave,.json"
                            onChange={importarArquivo}
                        />
                    </>
                );
            }

            if (view === 'landing') {
                return (
                    <>
                        <LandingPage
                            onNovo={() => setView('criacao')}
                            onCarregar={() => {
                                if (getSaves().length > 0) abrirMenuCarregar();
                                else alert("Nenhum save encontrado no navegador. Tente importar um arquivo!");
                            }}
                            onImportar={triggerImport}
                        />
                        {/* Reutiliza o modal de carregar se precisar mostrar a lista ap√≥s import */}
                        {modal === 'carregar_menu' && (
                            <div className="absolute inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center p-8 z-50">
                                <div className="bg-zinc-900 border border-amber-500/30 p-6 rounded-2xl w-full max-w-2xl h-full overflow-y-auto relative animate-slide-up">
                                    <button onClick={() => setModal(null)} className="absolute top-4 right-4 text-zinc-500 hover:text-white text-xl">‚úï</button>
                                    <h2 className="text-3xl font-fantasy text-amber-500 mb-6 text-center">Carregar Jogo</h2>
                                    <div className="space-y-4">
                                        {getSaves().map(save => (
                                            <div key={save.id} className="bg-zinc-800 p-4 rounded-xl border border-zinc-700 hover:border-amber-500 cursor-pointer transition-all flex justify-between items-center group">
                                                <div className="flex-1" onClick={() => carregarSaveEspecifico(save)}>
                                                    <h3 className="font-bold text-lg text-zinc-200 group-hover:text-amber-400">{save.nome}</h3>
                                                    <p className="text-xs text-zinc-500">{new Date(save.data).toLocaleString()}</p>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <button onClick={(e) => { e.stopPropagation(); deletarSave(save.id); }} className="p-2 text-zinc-600 hover:text-red-500 transition-colors">üóëÔ∏è</button>
                                                    <div className="text-2xl opacity-0 group-hover:opacity-100 transition-opacity" onClick={() => carregarSaveEspecifico(save)}>‚ñ∂Ô∏è</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                        <input
                            type="file"
                            ref={fileInputRef}
                            style={{ display: 'none' }}
                            accept=".rpgsave,.json"
                            onChange={importarArquivo}
                        />
                    </>
                )
            }

            // Modal Especial para Carregar no Menu (Renderizado Condicionalmente se view for menu? N√£o, o modal √© global do App, mas o App renderiza MenuPrincipal OU Jogo.
            // Precisamos que o modal de carregar funcione TANTO no menu quanto no jogo.
            // O MenuPrincipal substitui tudo, ent√£o se o modal for parte do App, ele deve estar fora do return condicional do Menu?
            // CORRE√á√ÉO: O MenuPrincipal √© uma view. Se o modal for estado do App, ele deve ser renderizado por cima.
            // Porem, se view === 'menu', retornamos direto o componente.
            // Vamos injetar o modal de carregar DENTRO do MenuPrincipal? Ou mudar a estrutura de retorno.

            // MELHOR: Renderizar o modal independente da view, SE ele estiver ativo.
            // Mas o MenuPrincipal est√° retornando FULL SCREEN.
            // VOU ALTERAR A ESTRUTURA DO RETURN FINAL.

            if (view === 'criacao') return <CriacaoScreen onCriar={criarPersonagem} onVoltar={() => setView('landing')} />;

            const localAtual = LOCAIS_FIXOS.find(l => l.nome === jogador.local);
            const ehCidade = localAtual && (localAtual.tipo === 'Cidade' || localAtual.tipo === 'Vila');

            // Determina a imagem de fundo baseada no tipo do local
            const MODAL_IMAGES = {
                'taverna': './assets/bg_taverna.png',
                'loja': './assets/bg_loja.png',
                'guilda': './assets/bg_guilda.png',
                'academia': './assets/bg_academia.png',
                'campeonato': './assets/bg_arena.png'
            };

            // Determina a imagem de fundo: Se tiver modal espec√≠fico, usa ele -> sen√£o bioma do local -> sen√£o Padr√£o
            const bgImage = (modal && MODAL_IMAGES[modal]) || BIOME_IMAGES[localAtual?.tipo] || BIOME_IMAGES['Padr√£o'];

            // DEBUG FORCE: Se n√£o achou imagem, alerta no console (j√° tem) 
            // Vamos remover a opacidade e o blur pra garantir visibilidade total

            return (
                <div className="h-[100dvh] w-full flex flex-col p-2 md:p-4 gap-2 md:gap-4 bg-transparent text-zinc-100 relative overflow-hidden transition-all duration-1000">

                    {/* MODAL LEVEL UP */}
                    {modal === 'levelup' && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 animate-fade-in text-center">
                            <div className="bg-zinc-900 border-2 border-amber-500 w-full h-full md:h-auto md:rounded-xl md:max-w-sm p-6 shadow-[0_0_50px_rgba(245,158,11,0.5)] relative overflow-hidden flex flex-col gap-4">
                                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-amber-500 to-transparent"></div>
                                <div className="mt-4 md:mt-0">
                                    <h2 className="text-3xl font-medieval text-amber-500 animate-pulse">LEVEL UP!</h2>
                                    <p className="text-zinc-400">Voc√™ alcan√ßou o <strong>N√≠vel {jogador.nivel}</strong>!</p>
                                </div>
                                <div className="text-6xl animate-bounce my-2">üÜô</div>

                                <div className="bg-black/30 p-3 rounded-lg border border-white/5">
                                    <div className="text-[10px] uppercase font-bold text-zinc-500">Pontos Dispon√≠veis</div>
                                    <div className="text-4xl font-bold text-amber-400">{jogador.pontosAtributo}</div>
                                </div>

                                <div className="grid grid-cols-1 gap-2 text-left bg-black/20 p-2 rounded flex-1 overflow-y-auto">
                                    {['forca', 'armadura', 'habilidade', 'poderDeFogo', 'resistencia'].map(attr => (
                                        <div key={attr} className="flex justify-between items-center bg-white/5 p-3 rounded hover:bg-white/10 transition-colors">
                                            <div className="flex items-center gap-2">
                                                <span className="text-2xl">{attr === 'forca' ? '‚öîÔ∏è' : attr === 'armadura' ? 'üõ°Ô∏è' : attr === 'habilidade' ? '‚ö°' : attr === 'poderDeFogo' ? 'üî•' : 'üî∞'}</span>
                                                <span className="uppercase text-sm font-bold text-zinc-300 w-20">{attr === 'poderDeFogo' ? 'PDF' : attr === 'armadura' ? 'ARM' : attr === 'resistencia' ? 'RES' : attr.substring(0, 3)}</span>
                                            </div>
                                            <div className="flex items-center gap-4">
                                                <span className="font-bold text-zinc-400 text-lg">{jogador.atributosBase[attr]}</span>
                                                <button
                                                    onClick={() => evoluirAtributo(attr)}
                                                    disabled={jogador.pontosAtributo <= 0}
                                                    className="w-10 h-10 rounded bg-amber-600 hover:bg-amber-500 disabled:opacity-30 disabled:cursor-not-allowed flex items-center justify-center font-bold text-black shadow-lg text-lg"
                                                >
                                                    +
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <button onClick={() => setModal(null)} className="w-full py-4 md:py-3 bg-zinc-800 hover:bg-zinc-700 border border-zinc-600 rounded-lg font-bold text-zinc-300 hover:text-white transition-colors text-lg md:text-base mb-4 md:mb-0">
                                    FECHAR
                                </button>
                            </div>
                        </div>
                    )}


                    {/* Camada de Fundo Real (Fixed para garantir que cubra tura) */}
                    <div className="fixed inset-0 z-[-10] bg-black">
                        <img
                            src={bgImage}
                            alt="Background"
                            className="w-full h-full object-cover opacity-80 transition-all duration-1000"
                        />
                        <div className="absolute inset-0 bg-gradient-to-b from-black/40 via-black/10 to-black/70"></div>
                    </div>

                    {/* Debug Invis√≠vel (Console) */}
                    <div className="hidden">{jogador.local} - {localAtual?.tipo} - {bgImage}</div>

                    <div className="flex flex-col md:flex-row gap-2 md:gap-4 h-full overflow-hidden relative z-10">
                        {/* Sidebar Responsiva */}
                        <div className="w-full md:w-64 h-auto md:h-full flex-shrink-0 order-2 md:order-1 max-h-[35vh] md:max-h-full overflow-y-auto glass-card rounded-t-2xl md:rounded-2xl p-3 md:p-4 flex flex-col gap-2 md:gap-4 no-scrollbar">
                            <div className="flex md:block items-center justify-between gap-4">
                                <div className="flex items-center gap-3 md:block md:text-center">
                                    <div className="text-3xl md:text-4xl">{CLASSES[jogador.classe].icon}</div>
                                    <div className="md:mt-2">
                                        <h2 className="text-lg md:text-xl font-bold text-amber-500 leading-tight">{jogador.nome}</h2>
                                        <p className="text-[10px] md:text-xs uppercase text-zinc-400">Nvl {jogador.nivel} {jogador.classe}</p>
                                    </div>
                                </div>
                                {/* Dinheiro no Mobile fica aqui do lado */}
                                <div className="md:hidden text-right p-2 bg-amber-900/20 rounded border border-amber-500/20 text-amber-400 font-bold text-sm">
                                    üí∞ {jogador.ouro}
                                </div>
                            </div>

                            <div className="space-y-1.5 md:space-y-2 text-sm">
                                {jogador.pontosAtributo > 0 && (
                                    <button onClick={() => setModal('levelup')} className="w-full py-2 text-xs bg-amber-900/80 hover:bg-amber-800 text-amber-100 border border-amber-500/50 rounded animate-pulse flex items-center justify-center gap-2 font-bold shadow-lg shadow-amber-900/20">
                                        <span>‚ú®</span> {jogador.pontosAtributo} PONTOS
                                    </button>
                                )}
                                <Barra label="PV" atual={jogador.hp} max={jogador.maxHp} cor="bg-red-600" />
                                <Barra label={CLASSES[jogador.classe]?.recurso?.nome || "PM"} atual={jogador.mana} max={jogador.maxMana} cor={CLASSES[jogador.classe]?.recurso?.cor || "bg-blue-600"} />
                                <Barra label="XP" atual={jogador.xp} max={jogador.proximoXp} cor="bg-purple-600" />
                            </div>

                            <div className="grid grid-cols-4 md:grid-cols-2 gap-1.5 md:gap-2 text-center text-xs">
                                <Stat icone="‚öîÔ∏è" valor={atributos.forca} label="FOR" />
                                <Stat icone="üõ°Ô∏è" valor={atributos.armadura} label="ARM" />
                                <Stat icone="‚ö°" valor={atributos.habilidade} label="HAB" />
                                <Stat icone="üî•" valor={atributos.poderDeFogo} label="PDF" />
                                <div className="col-span-4 md:col-span-2">
                                    <Stat icone="üî∞" valor={atributos.resistencia} label="RES" />
                                </div>
                            </div>

                            {/* BOT√ïES DE A√á√ÉO RESTAURADOS */}
                            <div className="flex gap-2 mt-auto">
                                <button onClick={() => setModal('inventario')} className="flex-1 py-2 bg-zinc-800 hover:bg-zinc-700 border border-zinc-600 rounded-lg font-bold flex items-center justify-center gap-2 hover:border-amber-500 transition-all text-xs md:text-sm">
                                    üéí <span className="hidden md:inline">MOCHILA</span>
                                </button>
                                <button onClick={() => setModal('sistema')} className="px-3 py-2 bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 rounded-lg font-bold flex items-center justify-center gap-2 hover:border-zinc-500 transition-all text-xs text-zinc-400">
                                    ‚öôÔ∏è
                                </button>
                            </div>

                            <div className="hidden md:block text-center p-2 bg-amber-900/20 rounded border border-amber-500/20 text-amber-400 font-bold">
                                üí∞ {jogador.ouro}
                            </div>
                        </div>

                        {/* Main Area */}
                        <div className="flex-1 flex flex-col gap-2 md:gap-4 relative order-1 md:order-2 overflow-hidden min-h-0">
                            {/* Header Loc */}
                            <div className="glass-card p-4 rounded-xl flex flex-row justify-between items-center gap-4">
                                <div className="min-w-fit">
                                    <h1 className="text-2xl font-fantasy text-amber-100">{jogador.local}</h1>
                                    <p className="text-xs text-zinc-400">{localAtual?.descricao}</p>
                                </div>
                                <div className="flex gap-2 overflow-x-auto w-full md:w-auto pb-2 md:pb-0 scroll-hide justify-start md:justify-end">
                                    {ehCidade && (
                                        <>
                                            <BtnCidade icone="üõí" label="Loja" onClick={() => setModal('loja')} disabled={monstros.length > 0} />
                                            <BtnCidade icone="üìú" label="Guilda" onClick={abrirGuilda} disabled={monstros.length > 0} />
                                            <BtnCidade icone="üéì" label="Habilidades" onClick={() => setModal('academia')} disabled={monstros.length > 0} />
                                            <BtnCidade icone="üç∫" label="Taverna" onClick={abrirTaverna} disabled={monstros.length > 0} />

                                            {/* BOT√ÉO DO CAMPEONATO */}
                                            {campeonatoDisponivel ? (
                                                <button disabled={monstros.length > 0} onClick={() => setModal('campeonato')} className={`flex items-center gap-2 bg-gradient-to-r from-yellow-700 to-yellow-500 hover:from-yellow-600 hover:to-yellow-400 px-3 py-2 rounded-lg border-2 border-yellow-300 shadow-[0_0_15px_rgba(234,179,8,0.5)] animate-pulse transition-all text-sm font-bold text-black flex-1 md:flex-none justify-center ${monstros.length > 0 ? 'opacity-50 cursor-not-allowed grayscale' : ''}`}>
                                                    <span className="text-lg">üèÜ</span> <span className="inline">CAMP.</span>
                                                </button>
                                            ) : (
                                                <button disabled className="flex items-center gap-2 bg-zinc-900 px-3 py-2 rounded-lg border border-zinc-800 text-sm font-bold text-zinc-600 opacity-50 cursor-not-allowed flex-1 md:flex-none justify-center" title={`Pr√≥ximo em: ${Math.floor(tempoAteCampeonato / 60)}m ${tempoAteCampeonato % 60}s`}>
                                                    <span className="text-lg">‚è≥</span> <span className="inline">{Math.floor(tempoAteCampeonato / 60)}:{String(tempoAteCampeonato % 60).padStart(2, '0')}</span>
                                                </button>
                                            )}
                                        </>
                                    )}
                                    <BtnCidade icone="üó∫Ô∏è" label="Viajar" onClick={() => setModal('mapa')} disabled={monstros.length > 0} />
                                </div>
                            </div>

                            {/* Game Area */}
                            <div className="flex-1 glass-card rounded-xl overflow-y-auto relative bg-black/40 flex flex-col scroll-hide min-h-0 border border-white/5 backdrop-blur-[2px]">
                                {monstros.length > 0 ? (
                                    <div className="flex-1 flex flex-col p-4 relative">

                                        {campeonatoAtivo && (
                                            <div className="absolute top-2 left-1/2 transform -translate-x-1/2 bg-yellow-900/90 text-yellow-100 px-6 py-1 rounded-full border border-yellow-500 text-sm font-bold z-30 shadow-[0_0_15px_rgba(234,179,8,0.5)] flex items-center gap-2 animate-pulse">
                                                <span>üèÜ</span> ROUND {rodadaCampeonato}/5
                                            </div>
                                        )}

                                        {/* √ÅREA DO MONSTRO (TOPO DIREITA) */}
                                        {/* √ÅREA DOS MONSTROS (TOPO) */}
                                        <div className="flex justify-center gap-4 mb-2 animate-slide flex-wrap p-4 flex-shrink-0">
                                            {monstros.map((monstro, idx) => (
                                                <div key={monstro.uid || idx} className="relative group flex flex-col items-center">

                                                    {/* Visual do Monstro */}
                                                    <div className="text-6xl filter drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)] transform hover:scale-105 transition-transform cursor-crosshair relative z-10 animate-float mb-2">
                                                        {getMonsterIcon(monstro.nome)}
                                                    </div>

                                                    <div className="w-16 h-2 bg-black/40 blur-lg rounded-[100%] absolute top-[50px]"></div>

                                                    {/* Info Card (Agora embaixo para n√£o tapar) */}
                                                    <div className="bg-zinc-900/90 border border-red-900/50 p-2 rounded-lg min-w-[100px] shadow-xl backdrop-blur-sm z-20 text-center">
                                                        <div className="font-bold text-[10px] text-zinc-100 leading-tight mb-1">{monstro.nome}</div>
                                                        <div className="h-1.5 bg-zinc-800 rounded-full overflow-hidden border border-zinc-700 w-full">
                                                            <div className="h-full bg-red-600 transition-all duration-300" style={{ width: `${(monstro.hp / monstro.maxHp) * 100}%` }}></div>
                                                        </div>
                                                        <div className="text-[8px] text-zinc-500 mt-0.5">{monstro.hp}/{monstro.maxHp}</div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>

                                        {/* ESPA√áO VAZIO (CAMPO DE BATALHA) */}
                                        <div className="flex-1"></div>

                                        {/* √ÅREA DO JOGADOR (BAIXO ESQUERDA) */}
                                        <div className="flex flex-col md:flex-row justify-between items-center md:items-end animate-slide-up gap-4 md:gap-0 mt-4 md:mt-0">
                                            <div className="relative order-2 md:order-1">
                                                {/* Visual do Jogador */}
                                                <div className="text-6xl md:text-5xl relative z-10 transform scale-x-[-1] ml-2">
                                                    {CLASSES[jogador.classe]?.icon || 'üó°Ô∏è'}
                                                </div>
                                                <div className="w-full h-3 bg-black/40 blur-md absolute bottom-1 rounded-[100%] ml-2"></div>
                                            </div>

                                            {/* Status Card e Controles */}
                                            <div className="flex-1 w-full md:w-auto md:ml-4 max-w-[300px] order-1 md:order-2">
                                                <div className="bg-zinc-900/90 border border-amber-500/30 p-3 rounded-lg shadow-2xl backdrop-blur-sm mb-2">
                                                    <div className="flex justify-between items-baseline mb-1">
                                                        <span className="font-bold text-sm text-amber-500 truncate">{jogador.nome}</span>
                                                        <span className="text-[9px] text-zinc-400">Nvl {jogador.nivel}</span>
                                                    </div>

                                                    {/* Barra PV */}
                                                    <div className="flex items-center gap-1 mb-0.5">
                                                        <span className="text-[8px] font-bold w-3">PV</span>
                                                        <div className="flex-1 h-2 bg-zinc-800 rounded-full border border-zinc-700 overflow-hidden relative">
                                                            <div className="h-full bg-gradient-to-r from-green-600 to-green-400 absolute transition-all duration-500" style={{ width: `${(jogador.hp / jogador.maxHp) * 100}%` }}></div>
                                                        </div>
                                                    </div>

                                                    {/* Barra RESOURCE */}
                                                    <div className="flex items-center gap-1 mb-2">
                                                        <span className={`text-[8px] font-bold w-3 ${CLASSES[jogador.classe]?.recurso?.cor.replace('bg-', 'text-').replace('600', '300') || 'text-blue-300'}`}>{CLASSES[jogador.classe]?.recurso?.nome.substring(0, 2) || "PM"}</span>
                                                        <div className="flex-1 h-1.5 bg-zinc-800 rounded-full border border-zinc-700 overflow-hidden relative">
                                                            <div className={`h-full ${CLASSES[jogador.classe]?.recurso?.cor || "bg-blue-600"} absolute transition-all duration-500`} style={{ width: `${(jogador.mana / jogador.maxMana) * 100}%` }}></div>
                                                        </div>
                                                    </div>

                                                    {/* Atributos Manuais (Escondidos no mobile pois j√° tem na sidebar) */}
                                                    <div className="hidden md:grid mb-2 text-[8px] grid-cols-2 gap-x-2 gap-y-0.5 mt-2 bg-black/20 p-1 rounded">
                                                        {/* For√ßa */}
                                                        <div className="flex justify-between items-center text-zinc-400">
                                                            <span>FOR: {atributos.forca}</span>
                                                            {jogador.pontosAtributo > 0 && <button onClick={() => evoluirAtributo('forca')} className="text-amber-400 hover:text-white font-bold bg-zinc-800 px-1.5 rounded transition-colors border border-amber-900/50">+</button>}
                                                        </div>
                                                        {/* Armadura */}
                                                        <div className="flex justify-between items-center text-zinc-400">
                                                            <span>ARM: {atributos.armadura}</span>
                                                            {jogador.pontosAtributo > 0 && <button onClick={() => evoluirAtributo('armadura')} className="text-amber-400 hover:text-white font-bold bg-zinc-800 px-1.5 rounded transition-colors border border-amber-900/50">+</button>}
                                                        </div>
                                                        {/* Habilidade */}
                                                        <div className="flex justify-between items-center text-zinc-400">
                                                            <span>HAB: {atributos.habilidade}</span>
                                                            {jogador.pontosAtributo > 0 && <button onClick={() => evoluirAtributo('habilidade')} className="text-amber-400 hover:text-white font-bold bg-zinc-800 px-1.5 rounded transition-colors border border-amber-900/50">+</button>}
                                                        </div>
                                                        {/* Poder de Fogo */}
                                                        <div className="flex justify-between items-center text-zinc-400">
                                                            <span className={jogador.classe === 'Mago' ? 'text-blue-300 font-bold' : ''}>PDF: {atributos.poderDeFogo}</span>
                                                            {jogador.pontosAtributo > 0 && <button onClick={() => evoluirAtributo('poderDeFogo')} className="text-amber-400 hover:text-white font-bold bg-zinc-800 px-1.5 rounded transition-colors border border-amber-900/50">+</button>}
                                                        </div>
                                                        {/* Resist√™ncia */}
                                                        <div className="flex justify-between items-center text-zinc-400 col-span-2">
                                                            <span>RES: {atributos.resistencia}</span>
                                                            {jogador.pontosAtributo > 0 && <button onClick={() => evoluirAtributo('resistencia')} className="text-amber-400 hover:text-white font-bold bg-zinc-800 px-1.5 rounded transition-colors border border-amber-900/50">+</button>}
                                                        </div>
                                                    </div>

                                                    {jogador.pontosAtributo > 0 && (
                                                        <div className="text-[9px] text-center text-yellow-300 font-bold animate-pulse mb-1 border border-yellow-500/30 bg-yellow-900/20 rounded py-0.5">
                                                            ‚ú® {jogador.pontosAtributo} PONTOS DISPON√çVEIS ‚ú®
                                                        </div>
                                                    )}

                                                    <div className="h-px bg-zinc-700 my-1.5"></div>

                                                    {/* Botoes de A√ß√£o */}
                                                    <div className="grid grid-cols-2 gap-2 md:gap-1 mt-2">
                                                        <button onClick={atacar} className="col-span-1 bg-red-600 hover:bg-red-500 text-white py-3 md:py-1.5 rounded-lg md:rounded font-bold text-sm md:text-xs shadow hover:shadow-red-500/20 transition-all active:scale-95 flex items-center justify-center gap-1 border-b-2 border-red-800">
                                                            <span>‚öîÔ∏è</span> ATACAR
                                                        </button>
                                                        <button onClick={fugir} className="col-span-1 bg-zinc-600 hover:bg-zinc-500 text-white py-3 md:py-1.5 rounded-lg md:rounded font-bold text-sm md:text-xs shadow hover:shadow-zinc-500/20 transition-all active:scale-95 flex items-center justify-center gap-1 border-b-2 border-zinc-800">
                                                            <span>üèÉ</span> FUGIR
                                                        </button>
                                                        {jogador.magias.map(magia => (
                                                            <button
                                                                key={magia.id}
                                                                onClick={() => usarHabilidade(magia)}
                                                                className="col-span-1 bg-cyan-700 hover:bg-cyan-600 text-white py-3 md:py-1.5 rounded-lg md:rounded font-bold text-xs md:text-[10px] flex flex-col items-center justify-center border-b-2 border-cyan-800 transition-all active:scale-95 hover:shadow-cyan-500/20"
                                                                title={`${magia.desc} (Dano/Poder: ${magia.poder})`}
                                                            >
                                                                <span>{magia.tipo === 'Cura' ? 'üíñ' : '‚ö°'} {magia.nome}</span>
                                                                <span className="text-[10px] md:text-[8px] opacity-80">{magia.mana} MP</span>
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                ) : (
                                    <div className="flex-1 flex flex-col items-center justify-center relative pb-32">
                                        {/* Background Decorativo - Removido √≠cones pois agora temos BG real */}
                                        {/* <div className="absolute inset-0 opacity-20 pointer-events-none flex items-center justify-center text-9xl filter blur-sm">
                                            {ehCidade ? 'üè∞' : 'üå≤'}
                                        </div> */}

                                        <div className="text-center space-y-4 relative z-10">
                                            {!ehCidade ? (
                                                <button onClick={explorar} className="p-2 md:p-8 bg-zinc-800 hover:bg-zinc-700 rounded-full w-24 h-24 md:w-48 md:h-48 flex flex-col items-center justify-center gap-1 md:gap-2 border-4 border-zinc-600 hover:border-amber-500 transition-all hover:scale-105 group shadow-[0_0_30px_rgba(0,0,0,0.5)] flex-shrink-0">
                                                    <span className="text-3xl md:text-5xl group-hover:rotate-12 transition-transform">üß≠</span>
                                                    <span className="font-bold text-[10px] md:text-xl tracking-widest text-zinc-300 group-hover:text-amber-400">EXPLORAR</span>
                                                </button>
                                            ) : (
                                                <div className="glass-card p-6 rounded-2xl max-w-md border border-amber-500/20 bg-black/60 flex flex-col items-center">
                                                    <h3 className="text-xl font-fantasy text-amber-500 mb-2">Zona Segura</h3>
                                                    <p className="text-zinc-400 italic text-sm mb-4 text-center">Voc√™ est√° descansando na cidade. Visite as lojas ou a guilda.</p>

                                                    {/* Bot√£o para ca√ßar na cidade (Ratos, Ladr√µes) */}
                                                    <button onClick={explorar} className="py-2 px-6 bg-zinc-800 hover:bg-red-900/40 border border-zinc-600 hover:border-red-500 rounded-lg flex items-center gap-2 group transition-all">
                                                        <span className="text-xl group-hover:scale-110 transition-transform">üó°Ô∏è</span>
                                                        <span className="font-bold text-zinc-300 group-hover:text-red-400">Explorar Arredores</span>
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Logs */}
                            <div className="h-24 md:h-40 glass-card rounded-xl p-3 overflow-y-auto font-mono text-xs space-y-1 flex-shrink-0" ref={logRef}>
                                {logs.map(log => (
                                    <div key={log.id} className={`${log.tipo === 'perigo' ? 'text-red-300' : log.tipo === 'loot' ? 'text-amber-300' : log.tipo === 'sucesso' ? 'text-green-300' : 'text-zinc-400'}`}>
                                        {'> '}{log.msg}
                                    </div>
                                ))}
                            </div>

                            {/* MODAL DE MORTE (Overlay Global) */}
                            {jogador.hp <= 0 && (
                                <div className="absolute inset-0 bg-red-900/90 backdrop-blur-lg flex items-center justify-center p-8 z-[100] animate-pulse-slow">
                                    <div className="text-center">
                                        <div className="text-8xl mb-4">‚ò†Ô∏è</div>
                                        <h2 className="text-4xl font-fantasy text-white mb-2">VOC√ä EST√Å INCONSCIENTE!</h2>
                                        <p className="text-red-200 mb-8 max-w-md mx-auto">
                                            Seus ferimentos foram fatais. Voc√™ precisa ser resgatado e levado de volta √† vila.
                                        </p>

                                        <button
                                            onClick={respawn}
                                            className="px-8 py-4 bg-white text-black font-bold rounded-xl text-xl hover:scale-105 transition-transform shadow-[0_0_50px_rgba(255,255,255,0.5)] border-4 border-red-500"
                                        >
                                            RENASCER
                                            <div className="text-xs font-normal mt-1 text-zinc-500">
                                                (Taxa de resgate: {Math.floor(jogador.ouro * 0.1)} Ouro)
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            )}

                        </div>
                    </div>

                    {/* Modal Overlay Gen√©rico (Mobile Fullscreen) */}
                    {modal && modal !== 'levelup' && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-0 md:p-4 animate-fade-in text-white">
                            <div className="bg-zinc-900/95 backdrop-blur-md md:rounded-xl border-0 md:border border-amber-500/30 w-full h-full md:h-auto md:max-w-2xl max-h-full md:max-h-[85vh] overflow-hidden flex flex-col shadow-2xl">
                                {/* Modal Header */}
                                <div className="flex justify-between items-center p-4 border-b border-white/10 bg-black/40">
                                    <h3 className="text-xl font-fantasy text-amber-500 capitalize">{modal}</h3>
                                    <button onClick={() => setModal(null)} className="text-zinc-400 hover:text-white p-2">‚úï</button>
                                </div>

                                {/* Modal Content */}
                                <div className="p-4 md:p-6 overflow-y-auto flex-1">
                                    {modal === 'campeonato' && (
                                        <div className="text-center">
                                            <div className="text-6xl mb-4">üèÜ</div>
                                            <h2 className="text-3xl font-fantasy text-amber-500 mb-2">Grande Campeonato de {localAtual.nome}</h2>
                                            <p className="text-zinc-400 mb-6 max-w-lg mx-auto">
                                                Guerreiros de todo o reino se re√∫nem para provar seu valor.
                                                Sobreviva a <strong>5 rodadas consecutivas</strong> contra gladiadores de elite para ganhar fama e fortuna!
                                            </p>

                                            <div className="bg-black/30 p-4 rounded-xl border border-amber-900/30 mb-8 max-w-md mx-auto">
                                                <h3 className="text-amber-200 font-bold mb-2">Pr√™mio do Campe√£o</h3>
                                                <div className="flex justify-center gap-8 text-sm">
                                                    <div className="flex flex-col items-center">
                                                        <span className="text-2xl">üí∞</span>
                                                        <span className="text-yellow-400 font-bold">{500 * jogador.nivel} Ouro</span>
                                                    </div>
                                                    <div className="flex flex-col items-center">
                                                        <span className="text-2xl">‚ú®</span>
                                                        <span className="text-purple-400 font-bold">{200 * jogador.nivel} XP</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <button onClick={iniciarCampeonato} className="px-8 py-3 bg-gradient-to-r from-amber-700 to-amber-500 hover:from-amber-600 hover:to-amber-400 text-black font-bold rounded-xl text-lg shadow-[0_0_20px_rgba(245,158,11,0.4)] transition-transform hover:scale-105 border-2 border-amber-300">
                                                ENTRAR NA ARENA
                                            </button>
                                            <div className="mt-4">
                                                <button onClick={() => setModal(null)} className="text-zinc-500 hover:text-white underline text-sm">Talvez mais tarde...</button>
                                            </div>
                                        </div>
                                    )}

                                    {modal === 'loja' && (
                                        <div>
                                            <h2 className="text-2xl font-fantasy text-amber-500 mb-6 flex items-center gap-2">üõí Mercado Local <span className="text-sm text-zinc-400 font-sans ml-auto">Seu Ouro: {jogador.ouro}</span></h2>
                                            <div className="grid gap-3">
                                                {ITENS_LOJA.filter(i => !i.classe || i.classe === jogador.classe || i.tipo === 'Consumivel').map(item => (
                                                    <div key={item.id} className="flex justify-between items-center p-3 bg-white/5 rounded-lg border border-white/5 hover:border-amber-500/50">
                                                        <div>
                                                            <div className="font-bold text-amber-100">{item.nome}</div>
                                                            <div className="text-xs text-zinc-500">{item.desc}</div>
                                                        </div>
                                                        <button onClick={() => comprarItem(item)} className="bg-green-700 hover:bg-green-600 px-4 py-2 rounded font-bold text-sm">Comprar {item.preco}üí∞</button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {modal === 'guilda' && (
                                        <div>
                                            <h2 className="text-2xl font-fantasy text-amber-500 mb-6">üìú Guilda de Aventureiros (Rank {jogador.rankGuilda})</h2>
                                            {jogador.missaoAtiva ? (
                                                <div className="text-center p-8 bg-blue-900/20 rounded-xl border border-blue-500/30">
                                                    <h3 className="text-xl mb-2">Miss√£o em Progresso</h3>
                                                    <p className="text-blue-300 font-bold text-lg">{jogador.missaoAtiva.titulo}</p>
                                                    <p className="text-zinc-400 mb-4">{jogador.missaoAtiva.desc}</p>
                                                    <p>Progresso: {jogador.missaoAtiva.atual}/{jogador.missaoAtiva.req}</p>

                                                    {jogador.missaoAtiva.atual >= jogador.missaoAtiva.req ? (
                                                        <button
                                                            onClick={() => {
                                                                if (jogador.missaoAtiva.tipo === 'evolucao') {
                                                                    const novaClasse = EVOLUCOES[jogador.classe];
                                                                    setJogador(p => ({
                                                                        ...p,
                                                                        classe: novaClasse,
                                                                        classeEvoluida: true,
                                                                        missaoAtiva: null,
                                                                        ouro: p.ouro + 1000,
                                                                        maxHp: p.maxHp + 50, // Bonus evolu√ß√£o
                                                                        hp: p.maxHp + 50,
                                                                        maxMana: p.maxMana + 20,
                                                                        mana: p.maxMana + 20
                                                                    }));
                                                                    addLog(`VOC√ä EVOLUIU PARA ${novaClasse.toUpperCase()}!`, 'sucesso');
                                                                    alert(`Parab√©ns! Voc√™ alcan√ßou o n√≠vel supremo e se tornou um ${novaClasse}!`);
                                                                } else {
                                                                    // Miss√£o Normal
                                                                    // Check Rank Up
                                                                    const rankAtualIdx = RANKS_GUILDA.indexOf(jogador.rankGuilda);
                                                                    const missoesNecessarias = REQUISITOS_RANK[rankAtualIdx] || 9999;
                                                                    let novoRank = jogador.rankGuilda;
                                                                    let msgRank = "";

                                                                    if (jogador.missoesCompletas + 1 >= missoesNecessarias) {
                                                                        if (rankAtualIdx < RANKS_GUILDA.length - 1) {
                                                                            novoRank = RANKS_GUILDA[rankAtualIdx + 1];
                                                                            msgRank = ` SUBIU DE RANK: ${novoRank}!`;
                                                                            // Resetar miss√µes dispon√≠veis para gerar novas do rank novo
                                                                            setMissoesDisponiveis([]);
                                                                        }
                                                                    }

                                                                    setJogador(p => ({
                                                                        ...p,
                                                                        ouro: p.ouro + p.missaoAtiva.ouro,
                                                                        xp: p.xp + p.missaoAtiva.xp,
                                                                        missoesCompletas: p.missoesCompletas + 1,
                                                                        rankGuilda: novoRank,
                                                                        missaoAtiva: null
                                                                    }));
                                                                    addLog(`Miss√£o entregue! Recebeu ${jogador.missaoAtiva.ouro} ouro e ${jogador.missaoAtiva.xp} XP.${msgRank}`, 'sucesso');
                                                                }
                                                            }}
                                                            className="mt-4 bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg animate-pulse w-full"
                                                        >
                                                            COMPLETAR MISS√ÉO
                                                        </button>
                                                    ) : (
                                                        <button
                                                            onClick={cancelarMissao}
                                                            className="mt-4 bg-red-900/50 hover:bg-red-700 text-red-200 border border-red-800 font-bold py-2 px-6 rounded-lg w-full text-xs"
                                                        >
                                                            CANCELAR MISS√ÉO
                                                        </button>
                                                    )}

                                                </div>
                                            ) : (
                                                <div className="grid gap-4">
                                                    {/* Progress Bar do Rank */}
                                                    {RANKS_GUILDA.indexOf(jogador.rankGuilda) < RANKS_GUILDA.length - 1 && (
                                                        <div className="bg-black/30 p-3 rounded-lg border border-amber-900/30">
                                                            <div className="flex justify-between text-xs text-zinc-400 mb-1">
                                                                <span>Progresso para Rank {RANKS_GUILDA[RANKS_GUILDA.indexOf(jogador.rankGuilda) + 1]}</span>
                                                                <span>{jogador.missoesCompletas} / {REQUISITOS_RANK[RANKS_GUILDA.indexOf(jogador.rankGuilda)]}</span>
                                                            </div>
                                                            <div className="h-2 bg-black rounded-full overflow-hidden">
                                                                <div className="h-full bg-amber-600" style={{ width: `${Math.min(100, (jogador.missoesCompletas / REQUISITOS_RANK[RANKS_GUILDA.indexOf(jogador.rankGuilda)]) * 100)}%` }}></div>
                                                            </div>
                                                        </div>
                                                    )}

                                                    {/* Lista de Miss√µes */}
                                                    {missoesDisponiveis.map(m => (
                                                        <div key={m.id} className="p-4 bg-white/5 rounded-xl border-l-4 border-amber-500">
                                                            <h4 className="font-bold text-lg">{m.titulo} <span className="text-xs bg-amber-900 px-2 py-0.5 rounded ml-2">Rank {m.rank}</span></h4>
                                                            <p className="text-zinc-400 text-sm mb-3">{m.desc}</p>
                                                            <div className="flex justify-between items-center">
                                                                <div className="text-xs text-amber-300">Recompensa: {m.ouro} ouro, {m.xp} XP</div>
                                                                <button onClick={() => aceitarMissao(m)} className="bg-amber-600 hover:bg-amber-500 text-black font-bold px-4 py-2 rounded text-sm">Aceitar Contrato</button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {modal === 'academia' && (
                                        <div>
                                            <h2 className="text-2xl font-fantasy text-amber-500 mb-6">üìú Mestre de Habilidades</h2>
                                            <p className="text-zinc-400 mb-4 text-sm">Treine t√©cnicas exclusivas para {jogador.classe}.</p>
                                            <div className="grid gap-3">
                                                {HABILIDADES_LOJA.filter(h => h.classe === jogador.classe).length === 0 ? (
                                                    <p className="text-zinc-500 italic">Nenhuma habilidade dispon√≠vel para sua classe no momento.</p>
                                                ) : (
                                                    HABILIDADES_LOJA.filter(h => h.classe === jogador.classe || h.classe === 'Todas').map(habilidade => (
                                                        <div key={habilidade.id} className="flex justify-between items-center p-3 bg-white/5 rounded-lg border border-white/5 hover:border-amber-500/30 transition-colors">
                                                            <div>
                                                                <div className="font-bold text-blue-200">{habilidade.nome}</div>
                                                                <div className="text-xs text-zinc-500">{habilidade.desc}</div>
                                                                <div className="text-[10px] text-amber-400 font-mono mt-1">
                                                                    Dano: {habilidade.poder} | Custo: {habilidade.mana} MP | Tipo: {habilidade.tipo}
                                                                </div>
                                                            </div>
                                                            {jogador.magias.some(m => m.id === habilidade.id) ? (
                                                                <span className="text-green-500 text-xs font-bold px-3 py-2">APRENDIDO</span>
                                                            ) : (
                                                                <button onClick={() => aprenderHabilidade(habilidade)} className="bg-blue-700 hover:bg-blue-600 px-4 py-2 rounded font-bold text-sm transition-colors">
                                                                    Aprender {habilidade.custo}üí∞
                                                                </button>
                                                            )}
                                                        </div>
                                                    ))
                                                )}
                                            </div>
                                        </div>
                                    )}



                                    {modal === 'taverna' && (
                                        <div>
                                            <h2 className="text-2xl font-fantasy text-amber-500 mb-6">üç∫ Taverna do Javali</h2>
                                            <div className="bg-amber-900/20 p-6 rounded-xl border border-amber-500/30 text-center mb-6">
                                                <p className="text-xl mb-4 italic">"Bem-vindo, viajante! Sente-se, a lareira est√° quente."</p>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <button onClick={() => acaoTaverna('bebida')} className="p-4 bg-amber-800 hover:bg-amber-700 rounded-xl border border-amber-600 transition-all hover:scale-105">
                                                        <div className="text-4xl mb-2">üç∫</div>
                                                        <div className="font-bold">Beber Uma</div>
                                                        <div className="text-sm text-yellow-300">Custo: {Math.ceil(jogador.nivel * 2)}üí∞</div>
                                                        <div className="text-xs text-zinc-400 mt-1">Recupera um pouco de mana</div>
                                                    </button>
                                                    <button onClick={() => acaoTaverna('descanso')} className="p-4 bg-blue-900 hover:bg-blue-800 rounded-xl border border-blue-600 transition-all hover:scale-105">
                                                        <div className="text-4xl mb-2">üõèÔ∏è</div>
                                                        <div className="font-bold">Pernoitar</div>
                                                        <div className="text-sm text-yellow-300">Custo: {Math.ceil(jogador.nivel * 15)}üí∞</div>
                                                        <div className="text-xs text-zinc-400 mt-1">Recupera TODA Vida e Mana</div>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {modal === 'mapa' && (
                                        <div className="h-full flex flex-col justify-center overflow-y-auto">
                                            <h2 className="text-2xl font-fantasy text-amber-500 mb-4 flex-shrink-0 text-center">üó∫Ô∏è Mapa do Reino</h2>

                                            {/* Map Container - Responsive */}
                                            <div className="relative w-full max-w-4xl rounded-xl overflow-hidden border-2 border-amber-900/50 bg-stone-900 group shadow-2xl mx-auto flex-shrink-0">

                                                {/* Map Image - Tag img for correct aspect ratio */}
                                                <img
                                                    src="./assets/mapa.png?v=5"
                                                    alt="Mapa do Mundo"
                                                    className="w-full h-auto block opacity-50 grayscale group-hover:grayscale-0 group-hover:opacity-100 transition-all duration-1000"
                                                />

                                                {/* Locations Pins - Absolute positioned over image */}
                                                <div className="absolute inset-0">
                                                    {LOCAIS_FIXOS.map(local => {
                                                        const isCurrent = local.nome === jogador.local;
                                                        return (
                                                            <button
                                                                key={local.nome}
                                                                onClick={() => viajar(local)}
                                                                disabled={isCurrent}
                                                                style={{ left: `${local.x}%`, top: `${local.y}%` }}
                                                                className={`absolute transform -translate-x-1/2 -translate-y-1/2 transition-all duration-300 z-10 w-8 h-8 flex items-center justify-center rounded-full border-2 shadow-[0_0_15px_rgba(0,0,0,0.8)] group/pin
                                                                        ${isCurrent
                                                                        ? 'bg-amber-600 border-amber-300 scale-110 cursor-default animate-pulse'
                                                                        : 'bg-zinc-800 border-zinc-600 hover:bg-amber-700 hover:border-amber-400 hover:scale-125'}`}
                                                            >
                                                                <span className="text-sm">
                                                                    {local.tipo === 'Cidade' ? 'üè∞' :
                                                                        local.tipo === 'Vila' ? 'üè†' :
                                                                            local.tipo === 'P√¢ntano' ? '‚ò£Ô∏è' :
                                                                                local.nome === 'Floresta Sombria' ? '‚ò†Ô∏è' :
                                                                                    local.tipo === 'Floresta' ? 'üå≤' :
                                                                                        local.tipo === 'Montanha' ? 'üèîÔ∏è' : 'üìç'}
                                                                </span>

                                                                {/* Tooltip */}
                                                                <div className="absolute bottom-full mb-2 bg-black/90 text-amber-100 text-xs px-2 py-1 rounded whitespace-nowrap opacity-0 group-hover/pin:opacity-100 pointer-events-none border border-amber-500/30 transition-opacity z-20">
                                                                    <div className="font-bold">{local.nome}</div>
                                                                    <div className="text-zinc-400 text-[10px]">{local.tipo}</div>
                                                                    <div className="text-yellow-400 text-[10px]">Custo: {20 + (jogador.nivel * 5)} üí∞</div>
                                                                </div>
                                                            </button>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                            <div className="mt-4 text-center text-sm text-zinc-400 flex-shrink-0">
                                                Clique em um local para viajar ‚Ä¢ O local atual est√° pulsando em laranja
                                            </div>
                                        </div>
                                    )}
                                    {modal === 'inventario' && (
                                        <div>
                                            <h2 className="text-2xl font-fantasy text-amber-500 mb-6">üéí Invent√°rio & Equipamentos</h2>

                                            {/* Equipados */}
                                            <div className="mb-6 p-4 bg-zinc-800/50 rounded-xl border border-zinc-700">
                                                <h3 className="text-zinc-400 text-sm uppercase font-bold mb-3">Equipado</h3>
                                                <div className="grid grid-cols-3 gap-2">
                                                    {['arma', 'armadura', 'acessorio'].map(slot => (
                                                        <div key={slot} className="relative group">
                                                            <div className={`p-3 rounded-lg border flex flex-col items-center justify-center h-24 text-center ${jogador.equipamento[slot] ? 'bg-amber-900/20 border-amber-500/50' : 'bg-black/20 border-white/5'}`}>
                                                                {jogador.equipamento[slot] ? (
                                                                    <>
                                                                        <div className="font-bold text-amber-100 text-xs sm:text-sm">{jogador.equipamento[slot].nome}</div>
                                                                        <button onClick={() => desequipar(slot)} className="absolute -top-2 -right-2 bg-red-600 text-white w-6 h-6 rounded-full text-xs shadow-lg hover:scale-110 opacity-0 group-hover:opacity-100 transition-all">‚úï</button>
                                                                    </>
                                                                ) : (
                                                                    <div className="text-zinc-600 text-xs uppercase">{slot}</div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>

                                            {/* Mochila */}
                                            <div>
                                                <h3 className="text-zinc-400 text-sm uppercase font-bold mb-3">Na Mochila ({jogador.inventario.length} itens)</h3>
                                                {jogador.inventario.length === 0 ? (
                                                    <div className="text-zinc-500 italic text-center py-8">Sua mochila est√° vazia.</div>
                                                ) : (
                                                    <div className="grid sm:grid-cols-2 gap-2">
                                                        {jogador.inventario.map(item => (
                                                            <div key={item.uid} className="flex justify-between items-center p-2 bg-white/5 rounded border border-white/5 hover:border-amber-500/30 group">
                                                                <div>
                                                                    <div className="font-bold text-zinc-200">{item.nome}</div>
                                                                    <div className="text-[10px] text-zinc-500">{item.tipo}</div>
                                                                </div>
                                                                <div className="opacity-0 group-hover:opacity-100 transition-opacity">
                                                                    {item.tipo === 'Consumivel' ? (
                                                                        <button onClick={() => usarItem(item)} className="px-3 py-1 bg-green-700 hover:bg-green-600 rounded text-xs font-bold">Usar</button>
                                                                    ) : (
                                                                        <button onClick={() => equiparItem(item)} className="px-3 py-1 bg-blue-700 hover:bg-blue-600 rounded text-xs font-bold">Equipar</button>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}

                                    {modal === 'sistema' && (
                                        <div>
                                            <h2 className="text-2xl font-fantasy text-zinc-400 mb-6 flex items-center gap-2">‚öôÔ∏è Sistema</h2>
                                            <div className="grid gap-4">
                                                <div className="grid grid-cols-2 gap-2">
                                                    <button onClick={() => salvarJogo(false)} className="p-4 bg-green-900/40 hover:bg-green-800/60 border border-green-700/50 rounded-xl flex flex-col items-center gap-2 transition-all">
                                                        <span className="text-2xl">üíæ</span>
                                                        <div className="text-center">
                                                            <div className="font-bold text-green-200">Salvar</div>
                                                            <div className="text-[10px] text-zinc-400">Atualizar Atual</div>
                                                        </div>
                                                    </button>
                                                    <button onClick={() => salvarJogo(true)} className="p-4 bg-green-900/20 hover:bg-green-800/40 border border-green-700/30 rounded-xl flex flex-col items-center gap-2 transition-all">
                                                        <span className="text-2xl">‚ûï</span>
                                                        <div className="text-center">
                                                            <div className="font-bold text-green-200">Salvar Como</div>
                                                            <div className="text-[10px] text-zinc-400">Novo Arquivo</div>
                                                        </div>
                                                    </button>
                                                </div>

                                                <button onClick={carregarJogo} className="p-4 bg-blue-900/40 hover:bg-blue-800/60 border border-blue-700/50 rounded-xl flex items-center gap-4 transition-all">
                                                    <span className="text-3xl">üìÇ</span>
                                                    <div className="text-left">
                                                        <div className="font-bold text-blue-200">Carregar (Navegador)</div>
                                                        <div className="text-xs text-zinc-400">Recupera o save local.</div>
                                                    </div>
                                                </button>

                                                <div className="h-px bg-zinc-800/50"></div>

                                                <button onClick={exportarArquivo} className="p-4 bg-amber-900/40 hover:bg-amber-800/60 border border-amber-700/50 rounded-xl flex items-center gap-4 transition-all">
                                                    <span className="text-3xl">üì•</span>
                                                    <div className="text-left">
                                                        <div className="font-bold text-amber-200">Baixar Backup (PC)</div>
                                                        <div className="text-xs text-zinc-400">Cria arquivo para transferir de PC.</div>
                                                    </div>
                                                </button>

                                                <button onClick={triggerImport} className="p-4 bg-purple-900/40 hover:bg-purple-800/60 border border-purple-700/50 rounded-xl flex items-center gap-4 transition-all">
                                                    <span className="text-3xl">üì§</span>
                                                    <div className="text-left">
                                                        <div className="font-bold text-purple-200">Carregar do PC</div>
                                                        <div className="text-xs text-zinc-400">Restaura arquivo .rpgsave.</div>
                                                    </div>
                                                </button>

                                                <button onClick={reiniciarJogo} className="p-4 bg-red-900/40 hover:bg-red-800/60 border border-red-700/50 rounded-xl flex items-center gap-4 transition-all mt-8">
                                                    <span className="text-3xl">üö™</span>
                                                    <div className="text-left">
                                                        <div className="font-bold text-red-200">Sair do Jogo</div>
                                                        <div className="text-xs text-zinc-400">Volta para o menu principal.</div>
                                                    </div>
                                                </button>
                                            </div>
                                        </div>
                                    )}

                                    {modal === 'carregar_menu' && (
                                        <div>
                                            <h2 className="text-2xl font-fantasy text-amber-500 mb-6">üìÇ Carregar Jogo</h2>
                                            {getSaves().length === 0 ? (
                                                <p className="text-zinc-500 italic">Nenhum save encontrado.</p>
                                            ) : (
                                                <div className="grid gap-2 max-h-[60vh] overflow-y-auto pr-2">
                                                    {getSaves().map(save => (
                                                        <button key={save.id} onClick={() => carregarSaveEspecifico(save)} className="p-4 bg-white/5 border border-white/10 rounded-xl hover:bg-white/10 text-left group transition-all">
                                                            <div className="font-bold text-amber-100 group-hover:text-amber-400">{save.nome}</div>
                                                            <div className="text-xs text-zinc-500 flex justify-between mt-1">
                                                                <span>{save.data}</span>
                                                                <span>ID: {save.id.toString().slice(-4)}</span>
                                                            </div>
                                                        </button>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Isolado para o Menu Principal */}
                    {view === 'menu' && modal === 'carregar_menu' && (
                        <div className="absolute inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center p-8 z-50">
                            <div className="bg-zinc-900 border border-amber-500/30 p-6 rounded-2xl w-full max-w-lg relative">
                                <button onClick={() => setModal(null)} className="absolute top-4 right-4 text-zinc-500 hover:text-white text-xl">‚úï</button>
                                <h2 className="text-2xl font-fantasy text-amber-500 mb-6">üìÇ Carregar Jogo</h2>
                                <div className="grid gap-2 max-h-[60vh] overflow-y-auto pr-2">
                                    {getSaves().length === 0 ? <p className="text-zinc-500">Vazio.</p> : getSaves().map(save => (
                                        <button key={save.id} onClick={() => { carregarSaveEspecifico(save); }} className="p-4 bg-white/5 border border-white/10 rounded-xl hover:bg-white/10 text-left w-full">
                                            <div className="font-bold text-amber-100">{save.nome}</div>
                                            <div className="text-xs text-zinc-500">{save.data}</div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                    {/* INPUT DE ARQUIVO (OCULTO) */}
                    <input
                        type="file"
                        ref={fileInputRef}
                        style={{ display: 'none' }}
                        onChange={importarArquivo}
                        accept=".rpgsave,.json,application/json"
                    />
                </div>
            );
        };

        const CriacaoScreen = ({ onCriar, onVoltar }) => {
            const [nome, setNome] = React.useState("");
            const [raca, setRaca] = React.useState("Humano");
            const [classe, setClasse] = React.useState("Guerreiro");

            const racaAtual = RACAS[raca];

            return (
                <div className="min-h-screen flex items-center justify-center bg-black p-4 relative overflow-hidden">
                    {/* Background Animado (Zoom Lento) */}
                    <div className="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1519074069444-1ba4fff66d16?q=80&w=2000')] bg-cover bg-center animate-pulse-slow scale-110 transition-transform duration-[20s] ease-linear"></div>
                    <div className="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>

                    <div className="relative glass-card p-6 md:p-8 rounded-2xl w-full max-w-4xl animate-slide border border-amber-500/30 shadow-2xl flex flex-col md:flex-row gap-6">

                        {/* Left Side: Form */}
                        <div className="flex-1 flex flex-col gap-4">
                            <div className="text-center md:text-left">
                                <h1 className="text-4xl font-medieval text-amber-500 mb-2">Criar Her√≥i</h1>
                                <p className="text-zinc-400 text-sm">Sua lenda come√ßa aqui.</p>
                            </div>

                            {/* Nome Input */}
                            <div>
                                <label className="block text-xs uppercase font-bold text-zinc-500 mb-1">Nome do Her√≥i</label>
                                <input
                                    className="w-full bg-zinc-900 border border-zinc-700 p-3 rounded-lg text-white focus:border-amber-500 outline-none transition-colors font-medieval text-lg placeholder-zinc-700"
                                    value={nome}
                                    onChange={e => setNome(e.target.value)}
                                    placeholder="Ex: Aragorn"
                                />
                            </div>

                            {/* Race Selector Grid */}
                            <div>
                                <label className="block text-xs uppercase font-bold text-zinc-500 mb-2">Escolha sua Ra√ßa</label>
                                <div className="grid grid-cols-3 sm:grid-cols-5 gap-2">
                                    {Object.entries(RACAS).map(([key, data]) => (
                                        <button
                                            key={key}
                                            onClick={() => setRaca(key)}
                                            className={`p-2 rounded-lg border transition-all flex flex-col items-center justify-center gap-1 ${raca === key ? 'bg-amber-900/40 border-amber-500 scale-105 shadow-lg shadow-amber-900/20' : 'bg-zinc-900/40 border-white/5 hover:bg-zinc-800 hover:border-white/10'}`}
                                            title={data.trait.nome}
                                        >
                                            <div className="text-2xl">{key === 'Humano' ? 'üë®' : key === 'Elfo' ? 'üßù' : key === 'An√£o' ? 'üßî' : key === 'Orc' ? 'üëπ' : 'üëº'}</div>
                                            <div className={`text-[9px] font-bold uppercase ${raca === key ? 'text-amber-100' : 'text-zinc-500'}`}>{key}</div>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Class Selector */}
                            <div>
                                <label className="block text-xs uppercase font-bold text-zinc-500 mb-1">Classe</label>
                                <div className="grid grid-cols-3 gap-2 max-h-40 overflow-y-auto pr-1 customer-scrollbar">
                                    {Object.keys(CLASSES).filter(k => !['Cavaleiro', 'Arquimago', 'Assassino', 'Cruzado', 'Lich', 'Trovador', 'Sumo-Sacerdote', 'Guardi√£o', 'Sentinela'].includes(k)).map(c => (
                                        <button
                                            key={c}
                                            onClick={() => setClasse(c)}
                                            className={`p-2 rounded-lg border text-left flex items-center gap-2 transition-all ${classe === c ? 'bg-blue-900/40 border-blue-500' : 'bg-zinc-900/40 border-white/5 hover:bg-zinc-800'}`}
                                        >
                                            <span className="text-xl">{CLASSES[c].icon}</span>
                                            <div className="flex flex-col">
                                                <span className={`text-xs font-bold leading-none ${classe === c ? 'text-blue-100' : 'text-zinc-300'}`}>{c}</span>
                                                <span className="text-[9px] text-zinc-500 leading-none mt-0.5">{CLASSES[c].recurso.nome}</span>
                                            </div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Right Side: Preview */}
                        <div className="w-full md:w-72 bg-black/40 p-4 rounded-xl border border-white/5 flex flex-col">
                            <h3 className="text-zinc-400 text-xs uppercase font-bold mb-4 text-center">Resumo</h3>

                            <div className="flex-1 flex flex-col items-center justify-center mb-6">
                                <div className="text-6xl mb-4 animate-float">{CLASSES[classe].icon}</div>
                                <div className="text-xl font-bold text-white max-w-full truncate px-2">{nome || "Her√≥i"}</div>
                                <div className="text-sm text-amber-500">{raca} {classe}</div>
                            </div>

                            <div className="space-y-4 mb-6">
                                <div className="bg-amber-900/20 p-3 rounded border border-amber-500/20">
                                    <div className="text-xs text-amber-500 font-bold uppercase mb-1">Tra√ßo Racial</div>
                                    <div className="font-bold text-zinc-200 text-sm">{racaAtual.trait.nome}</div>
                                    <p className="text-xs text-zinc-400 mt-1">{racaAtual.trait.desc}</p>
                                </div>

                                <div className="bg-blue-900/20 p-3 rounded border border-blue-500/20">
                                    <div className="text-xs text-blue-400 font-bold uppercase mb-1">Especialidade</div>
                                    <p className="text-xs text-zinc-400">{CLASSES[classe].description}</p>
                                </div>
                            </div>

                            <div className="mt-auto flex gap-3">
                                <button onClick={onVoltar} className="px-4 py-3 bg-zinc-800 hover:bg-zinc-700 rounded-lg font-bold text-zinc-400 text-sm transition-colors border border-zinc-700 hover:text-zinc-200">Voltar</button>
                                <button
                                    onClick={() => onCriar({ nome, raca, classe })}
                                    disabled={!nome}
                                    className="flex-1 bg-gradient-to-r from-amber-700 to-amber-600 hover:from-amber-600 hover:to-amber-500 text-white font-bold p-3 rounded-lg text-sm transition-all shadow-[0_0_20px_rgba(245,158,11,0.2)] disabled:opacity-50 disabled:cursor-not-allowed hover:scale-[1.02]"
                                >
                                    INICIAR JORNADA
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )
        };

        const Barra = ({ label, atual, max, cor }) => (<div><div className="flex justify-between text-[10px] uppercase font-bold text-zinc-500"><span>{label}</span><span>{Math.ceil(atual)}/{max}</span></div><div className="h-1.5 bg-black/40 rounded-full overflow-hidden"><div className={`h-full ${cor}`} style={{ width: `${Math.min(100, (atual / max) * 100)}%` }}></div></div></div>);
        const Stat = ({ icone, valor, label }) => (<div className="bg-white/5 p-2 rounded-lg border border-white/5"><div className="text-lg">{icone}</div><div className="font-bold text-white">{valor}</div><div className="text-[9px] text-zinc-500">{label}</div></div>);
        const BtnCidade = ({ icone, label, onClick, disabled }) => (<button onClick={onClick} disabled={disabled} className={`flex items-center gap-2 bg-zinc-800 hover:bg-zinc-700 px-3 py-2 rounded-lg border border-white/10 hover:border-amber-500/50 transition-all text-sm font-bold ${disabled ? 'opacity-50 cursor-not-allowed pointer-events-none' : ''}`}><span className="text-lg">{icone}</span> <span className="hidden md:inline">{label}</span></button>);

        // Error Handler para capturar tela preta
        window.onerror = function (message, source, lineno, colno, error) {
            const div = document.createElement('div');
            div.style = "color:red; background:black; padding:20px; z-index:9999; position:fixed; top:0; left:0; width:100%; border-bottom: 2px solid white; font-family: sans-serif;";
            div.innerHTML = '<strong>ERRO CR√çTICO:</strong> ' + message + '<br><small>Linha: ' + lineno + '</small>';
            document.body.appendChild(div);
            console.error("Erro capturado:", message, error);
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>